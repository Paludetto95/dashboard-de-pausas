<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise de Pausas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <style>
        /* --- 1. Paleta de Cores e Tema --- */
        :root {
            --bg-main: #1C1C24;
            --bg-container: #252532;
            --text-main: #F0F0F0;
            --text-secondary: #A0A0A0;
            --highlight-primary: #3A7FFF;
            --highlight-secondary-yellow: #FBC02D;
            --highlight-secondary-purple: #E040FB;
            --status-success: #00C853;
            --status-danger: #D50000;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-secondary);
        }

        /* --- 2. Tipografia e Hierarquia --- */
        /* Título Principal do Dashboard */
        h1 {
            @apply text-4xl font-extrabold;
            color: var(--text-main);
        }

        /* Títulos de Widget/Card */
        h2 {
            @apply text-xl font-semibold;
            color: var(--text-main);
        }

        /* KPIs / Números Principais */
        .kpi-value {
            @apply text-4xl font-bold;
            color: var(--text-main);
        }
        
        /* Texto de Suporte (ex: "since last month") */
        .support-text {
            @apply text-sm font-regular;
            color: var(--text-secondary);
        }

        /* --- 3. Componentes e Layout --- */
        /* Layout Principal */
        #main-content {
            transition: padding-left 0.3s ease-in-out;
        }

        /* Menu Lateral (Sidebar) */
        #sidebar {
            background-color: var(--bg-container);
            @apply fixed top-0 left-0 h-full w-80 z-40 p-6 overflow-y-auto transform -translate-x-full transition-transform duration-300 ease-in-out border-r-0;
        }
        /* Adaptação para o menu de filtros já existente */
        #sidebar .card {
             background-color: #2D2D3A; /* Um pouco mais escuro para diferenciar */
        }
        /* Estilo para um item de menu ativo (exemplo, não implementado no HTML) */
        .menu-item.active {
            background-color: var(--highlight-primary);
            color: var(--text-main);
            @apply rounded-lg;
        }
        .menu-item svg { @apply stroke-current; }

        /* Cards/Widgets */
        .card {
            background-color: var(--bg-container);
            @apply p-8 rounded-3xl; /* Padding e bordas aumentados */
            /* Sem borda, sem sombra */
        }

        /* Botões */
        .btn {
            @apply px-6 py-3 font-semibold rounded-lg shadow-md transition duration-300 ease-in-out;
        }
        .btn-primary {
            background-color: var(--highlight-primary);
            color: var(--text-main);
        }
        .btn-primary:hover {
            filter: brightness(1.2);
        }
        .btn-danger {
            background-color: var(--status-danger);
            color: var(--text-main);
        }
        .btn-danger:hover {
             filter: brightness(1.2);
        }
        .btn-secondary {
            background-color: #4A4A58;
            color: var(--text-main);
        }
        .btn-secondary:hover {
            background-color: #5A5A68;
        }


        /* --- Elementos Específicos do Dashboard --- */
        
        /* Gráficos */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        @media (min-width: 768px) { .chart-container { height: 350px; } }

        /* Customização de Formulários */
        .form-input-dark {
            @apply block w-full pl-3 pr-4 py-2 text-base rounded-lg shadow-sm border-0;
            background-color: #2D2D3A;
            color: var(--text-main);
        }
        .form-input-dark:focus {
            @apply outline-none ring-2;
            ring-color: var(--highlight-primary);
        }
        .form-input-dark:disabled {
            background-color: #334155;
            opacity: 0.6;
        }
        
        /* Placeholder para input de data */
        .date-input { position: relative; color: var(--text-secondary); }
        .date-input:before {
            content: attr(data-placeholder);
            position: absolute;
            top: 50%; left: 0.75rem; transform: translateY(-50%);
            pointer-events: none;
        }
        .date-input:valid:before, .date-input:focus:before { display: none; }
        .date-input:valid, .date-input:focus { color: var(--text-main); }
        
        /* Modal de Erros */
        .modal-overlay {
            @apply fixed inset-0 flex justify-center items-center z-[1000];
            background-color: rgba(0, 0, 0, 0.8);
        }
        .modal-content {
            background-color: var(--bg-container);
            @apply p-8 rounded-2xl shadow-2xl max-w-2xl max-h-[80%] overflow-y-auto relative;
        }
        .modal-close-btn {
            @apply absolute top-4 right-4 bg-none border-none text-2xl cursor-pointer;
            color: var(--text-secondary);
        }
        .modal-close-btn:hover { color: var(--text-main); }
        .error-item {
            @apply border-l-4 p-3 mb-2 rounded;
            background-color: rgba(213, 0, 0, 0.2);
            border-color: var(--status-danger);
        }
        .error-item strong { color: #ff8a80; }
        .error-item span { color: #ffcdd2; }

        /* Spinner */
        .spinner {
            width: 1.5em; height: 1.5em;
            border: 3px solid rgba(255, 255, 255, .2);
            border-radius: 50%;
            border-top-color: var(--highlight-primary);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Estilos da Tabela (Tabulator) --- */
        #pause-detail-table {
            border: none;
        }
        #pause-detail-table .tabulator-header {
            background-color: var(--bg-container) !important;
            border-bottom: 1px solid #4A4A58 !important;
        }
        #pause-detail-table .tabulator-col,
        #pause-detail-table .tabulator-col-content {
             background-color: transparent !important;
        }
        #pause-detail-table .tabulator-col-title {
            color: var(--text-secondary) !important;
            font-weight: 500;
        }
        #pause-detail-table .tabulator-header .tabulator-header-filter input {
            background-color: #1C1C24 !important;
            color: var(--text-main) !important;
            border: 1px solid #4A4A58 !important;
            border-radius: 8px !important;
            padding: 6px 10px !important;
        }
        #pause-detail-table .tabulator-header .tabulator-header-filter input::placeholder {
             color: var(--text-secondary) !important;
             opacity: 0.7;
        }
        #pause-detail-table .tabulator-tableHolder {
            background-color: var(--bg-container) !important;
        }
        #pause-detail-table .tabulator-placeholder span {
             color: var(--text-secondary) !important;
        }
        #pause-detail-table .tabulator-row {
            background-color: transparent !important;
            border-bottom: 1px solid #2D2D3A !important;
        }
        #pause-detail-table .tabulator-row:hover {
            background-color: rgba(58, 127, 255, 0.1) !important;
        }
        #pause-detail-table .tabulator-cell {
            color: var(--text-main) !important;
            border-right: 1px solid #2D2D3A !important;
            padding: 12px 10px !important;
        }
        #pause-detail-table .tabulator-cell:last-of-type {
             border-right: none !important;
        }
        #pause-detail-table .tabulator-cell span:not([class*="text-"]) {
             color: var(--text-main) !important;
        }
        /* Cores Semânticas na Tabela */
         #pause-detail-table .status-success { color: var(--status-success) !important; }
         #pause-detail-table .status-danger { color: var(--status-danger) !important; }
         #pause-detail-table .status-warning { color: var(--highlight-secondary-yellow) !important; }

        /* Scrollbar */
        ::-webkit-scrollbar { height: 10px; width: 10px; }
        ::-webkit-scrollbar-track { background: #1C1C24; }
        ::-webkit-scrollbar-thumb {
            background-color: #4A4A58;
            border-radius: 5px;
            border: 2px solid #1C1C24;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <button id="sidebar-toggle-btn" class="fixed top-5 left-5 z-50 p-2 rounded-md bg-slate-800/50 text-white hover:bg-slate-700 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 hidden lg:hidden"></div>
    
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-80 bg-slate-900/70 backdrop-blur-lg border-r border-slate-700/80 z-40 p-6 overflow-y-auto transform -translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex flex-col gap-6">
            <div class="card">
                <h2 class="text-2xl font-semibold text-slate-100 mb-4 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span>Carregar Dados</span>
                </h2>
                <div class="flex flex-col gap-5">
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-2">Arquivo CSV</label>
                        <div class="flex items-center gap-2">
                            <label for="csv-file-input" class="cursor-pointer px-4 py-2 bg-slate-700 text-white font-semibold rounded-lg shadow-md hover:bg-slate-600 transition duration-300 ease-in-out whitespace-nowrap">
                                Escolher arquivo
                            </label>
                            <span id="file-name-display" class="text-sm text-slate-400 truncate">Nenhum...colhido</span>
                            <input type="file" id="csv-file-input" accept=".csv, .txt, .tsv" class="hidden"/>
                        </div>
                    </div>
                    <button id="load-api-data-btn" class="w-full px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 ease-in-out">
                        Carregar Dados Exemplo (API)
                    </button>
                </div>
                <p id="file-status" class="text-sm text-slate-400 mt-4">Nenhum arquivo carregado.</p>
            </div>

            <div class="card">
                <h2 class="text-2xl font-semibold text-slate-100 mb-4 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    <span>Filtros</span>
                </h2>
                <div class="flex flex-col gap-5">
                    <div class="flex justify-between items-center">
                        <label for="consultant-filter" class="text-sm font-medium text-slate-300">Consultor:</label>
                        <select id="consultant-filter" class="form-input-dark w-1/2" disabled>
                            <option value="">Todos</option>
                        </select>
                    </div>
                     <div class="flex justify-between items-center">
                        <label for="pause-type-filter" class="text-sm font-medium text-slate-300">Tipo de Pausa:</label>
                        <select id="pause-type-filter" class="form-input-dark w-1/2" disabled>
                            <option value="">Todos</option>
                        </select>
                    </div>
                     <div class="flex justify-between items-center">
                        <label for="start-date-filter" class="text-sm font-medium text-slate-300">Data Início:</label>
                        <input type="date" id="start-date-filter" class="form-input-dark w-1/2 date-input" data-placeholder="dd/mm/aaaa" disabled required>
                    </div>
                     <div class="flex justify-between items-center">
                        <label for="end-date-filter" class="text-sm font-medium text-slate-300">Data Fim:</label>
                        <input type="date" id="end-date-filter" class="form-input-dark w-1/2 date-input" data-placeholder="dd/mm/aaaa" disabled required>
                    </div>
                </div>
                <div class="flex flex-col gap-4 mt-6">
                    <button id="generate-ai-analysis-btn" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Gerar Análise com IA ✨
                    </button>
                    <button id="clear-filters-btn" class="w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 ease-in-out" disabled>
                        Limpar Filtros
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <main id="main-content" class="transition-all duration-300 ease-in-out">
        <div class="container mx-auto">
            <h1 class="text-4xl font-extrabold text-white mb-8 text-center">
                Dashboard de Pausas Consultores
            </h1>
    
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card text-center">
                    <p class="text-sm font-medium text-slate-400">Pausas Registradas</p>
                    <p id="kpi-total-pauses" class="text-4xl font-bold text-blue-400 mt-2">0</p>
                </div>
                <div class="card text-center">
                    <p class="text-sm font-medium text-slate-400">Total Global de Pausa</p>
                    <p id="kpi-total-global-pause" class="text-4xl font-bold text-green-400 mt-2">00:00</p>
                </div>
                <div class="card text-center">
                    <p class="text-sm font-medium text-slate-400">Consultores Únicos</p>
                    <p id="kpi-unique-consultants" class="text-4xl font-bold text-purple-400 mt-2">0</p>
                </div>
            </div>
    
            <div class="flex flex-col gap-6">
                <div id="ai-analysis-section" class="card hidden">
                    <h2 class="text-2xl font-semibold text-slate-100 mb-4">Análise de Pausas com IA</h2>
                    <div id="ai-analysis-content" class="bg-slate-900/50 p-4 rounded-lg text-slate-300 leading-relaxed min-h-[100px] flex items-center justify-center">
                        <p id="ai-loading-message" class="hidden text-center text-slate-400 flex items-center justify-center">
                            <div class="spinner mr-2"></div> Gerando análise... por favor, aguarde.
                        </p>
                        <p id="ai-placeholder-message" class="text-center text-slate-400">
                            Selecione um consultor e um período (opcional) e clique em "Gerar Análise com IA ✨" para ver um resumo personalizado.
                        </p>
                    </div>
                    <button id="close-ai-analysis-btn" class="mt-4 px-4 py-2 bg-slate-600 text-slate-100 font-semibold rounded-lg shadow-md hover:bg-slate-700 transition duration-300 ease-in-out">
                        Fechar Análise
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold text-slate-200 mb-4">Total de Duração por Consultor</h2>
                        <div class="chart-container">
                            <canvas id="total-pause-consultant-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-slate-200 mb-4">Total de Duração por Tipo</h2>
                        <div class="chart-container">
                            <canvas id="total-pause-type-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-slate-200 mb-4">Média de Duração por Tipo</h2>
                        <div class="chart-container">
                            <canvas id="average-pause-type-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-slate-200 mb-4">Distribuição do Tempo por Tipo</h2>
                        <div class="chart-container">
                            <canvas id="pause-type-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-semibold text-slate-100 mb-4">Detalhes das Pausas</h2>
                    <div id="pause-detail-table"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="ignored-rows-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="close-ignored-rows-modal-btn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-bold text-red-400 mb-4">⚠️ Linhas Ignoradas no CSV</h3>
            <p class="text-slate-300 mb-4">As seguintes linhas foram ignoradas devido a dados inválidos ou ausentes. Por favor, revise seu arquivo CSV.</p>
            <ul id="ignored-rows-list" class="space-y-2"></ul>
        </div>
    </div>


    <script>
        // --- Configuração Global ---
        // ... (resto do seu JS permanece igual) ...
        const COLUMN_ALIASES = {
            'CONSULTOR': ['operador', 'consultor', 'nome', 'agente', 'usuario', 'employee', 'name', 'colaborador'],
            'DURACAO': ['tempo', 'duracao', 'duration', 'time', 'periodo', 'horas'],
            'TIPO': ['descricao', 'descricao da pausa', 'tipo', 'motivo', 'reason', 'type', 'pausa', 'atividade'],
            'DATA_INICIO': ['inicio', 'data', 'data hora', 'data_inicio', 'start', 'date', 'hora inicio']
        };

        const EXPECTED_DURATIONS = {
            'Almoço': { minutes: 60, tolerance: 3 },
            'Café': { minutes: 15, tolerance: 2 },
            'Intervalo': { minutes: 15, tolerance: 2 },
            'Pausa Intervalo': { minutes: 15, tolerance: 2 },
            'Banheiro': { minutes: 10, tolerance: 3 },
            'Negociação': { minutes: 15, tolerance: 3 },
            'Em Negociação': { minutes: 15, tolerance: 3 },
            'Cadastrando Proposta': { minutes: 5, tolerance: 2 },
            'Pesquisando Lead': { minutes: 5, tolerance: 2 },
            'Novo Lead': { minutes: 5, tolerance: 2 }
        };

        let originalData = [];
        let filteredData = [];
        let filteredAveragesForComparison = {};
        let tabulatorTable = null;

        let charts = {
            consultantTotal: null,
            typeTotal: null,
            typeAverage: null,
            typeDistribution: null
        };

        const els = {
            fileInput: document.getElementById('csv-file-input'),
            fileNameDisplay: document.getElementById('file-name-display'),
            fileStatus: document.getElementById('file-status'),
            filters: {
                consultant: document.getElementById('consultant-filter'),
                pauseType: document.getElementById('pause-type-filter'),
                startDate: document.getElementById('start-date-filter'),
                endDate: document.getElementById('end-date-filter')
            },
            buttons: {
                clearFilters: document.getElementById('clear-filters-btn'),
                generateAi: document.getElementById('generate-ai-analysis-btn'),
                loadApi: document.getElementById('load-api-data-btn'),
                closeAi: document.getElementById('close-ai-analysis-btn')
            },
            kpis: {
                totalPauses: document.getElementById('kpi-total-pauses'),
                totalDuration: document.getElementById('kpi-total-global-pause'),
                uniqueConsultants: document.getElementById('kpi-unique-consultants')
            },
            ai: {
                section: document.getElementById('ai-analysis-section'),
                content: document.getElementById('ai-analysis-content'),
                loading: document.getElementById('ai-loading-message'),
                placeholder: document.getElementById('ai-placeholder-message')
            },
            ignoredRowsModal: {
                overlay: document.getElementById('ignored-rows-modal-overlay'),
                closeBtn: document.getElementById('close-ignored-rows-modal-btn'),
                list: document.getElementById('ignored-rows-list')
            },
            sidebar: {
                toggleBtn: document.getElementById('sidebar-toggle-btn'),
                overlay: document.getElementById('sidebar-overlay'),
                menu: document.getElementById('sidebar')
            },
            mainContent: document.getElementById('main-content')
        };

        // --- Funções Utilitárias ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        function parseDurationToMinutes(durationStr) {
            if (!durationStr) return 0;
            const cleanStr = durationStr.trim().replace(/^"|"$/g, '');
            const parts = cleanStr.split(':').map(Number);
            if (parts.length === 3) { return parts[0] * 60 + parts[1] + parts[2] / 60; }
            else if (parts.length === 2) { return parts[0] * 60 + parts[1]; }
            return 0;
        }
        function formatMinutesToHHMM(totalMinutes) {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '00:00';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }
        function formatMinutesToHHMMSS(totalMinutes) {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '00:00:00';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            const seconds = Math.round((totalMinutes - Math.floor(totalMinutes)) * 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        function normalizeHeader(str) {
            if (typeof str !== 'string') return '';
            return str.toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g, '').replace(/[^a-z0-9]/g, '');
        }
        function normalizeDataString(str) {
            if (!str) return 'Não informado';
            return str.trim().replace(/\s+/g, ' ');
        }
        function toTitleCase(str) {
            if (!str || str === 'Não informado') return str;
            return str.toLowerCase().split(' ').map(word => {
                if (word.length === 0) return '';
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }
        function parseDateTimeRobust(dateTimeStr) {
            if (!dateTimeStr || typeof dateTimeStr !== 'string' || dateTimeStr.trim() === '' || dateTimeStr.includes('#########') || dateTimeStr.includes('#')) { return null; }
            let cleanStr = dateTimeStr.trim().replace(/^"|"$/g, '');
            let date = new Date(cleanStr);
            if (!isNaN(date.getTime())) return date;
            const brRegex = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s+(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/;
            const match = cleanStr.match(brRegex);
            if (match) {
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10) - 1;
                const year = parseInt(match[3], 10);
                const hour = parseInt(match[4], 10);
                const minute = parseInt(match[5], 10);
                const second = match[6] ? parseInt(match[6], 10) : 0;
                date = new Date(year, month, day, hour, minute, second);
                if (!isNaN(date.getTime())) return date;
            }
            return null;
        }
        function formatDateToYYYYMMDD(date) {
            if (!date || isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
        }
        function formatDateTimeDisplay(date) {
            if (!date || isNaN(date.getTime())) return '';
            return date.toLocaleString('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
        function splitCsvLine(line, delimiter) {
            const regex = new RegExp(`${delimiter}(?=(?:(?:[^"]*\"){2})*[^"]*$)`);
            let values = line.split(regex);
            values = values.map(val => {
                let trimmed = val.trim();
                if (trimmed.length > 1 && trimmed.startsWith('"') && trimmed.endsWith('"')) {
                    trimmed = trimmed.substring(1, trimmed.length - 1);
                    trimmed = trimmed.replace(/""/g, '"');
                }
                return trimmed;
            });
            return values;
        }

        // --- Processamento de Dados ---
        function detectDelimiter(firstLine) {
            const delimiters = [';', ',', '\t', '|'];
            let bestDelimiter = null;
            let maxCount = 0;
            delimiters.forEach(delim => {
                const count = firstLine.split(delim).length;
                if (count > maxCount) {
                    maxCount = count;
                    bestDelimiter = delim;
                }
            });
            return maxCount > 1 ? bestDelimiter : null;
        }

        function mapHeaders(rawHeaders) {
            const headerMap = {};
            const normalizedRawHeaders = rawHeaders.map(h => ({ original: h, normalized: normalizeHeader(h) }));
            const requiredKeys = ['CONSULTOR', 'DURACAO', 'TIPO', 'DATA_INICIO'];
            let missingKeys = [];
            requiredKeys.forEach(key => {
                const aliases = COLUMN_ALIASES[key];
                let foundIndex = -1;
                for (let i = 0; i < normalizedRawHeaders.length; i++) {
                    const csvHeaderNorm = normalizedRawHeaders[i].normalized;
                    if (aliases.some(alias => csvHeaderNorm === alias || csvHeaderNorm.includes(alias))) {
                        foundIndex = i;
                        break;
                    }
                }
                if (foundIndex !== -1) {
                    headerMap[key] = foundIndex;
                } else {
                    missingKeys.push(key);
                }
            });
            return { map: headerMap, missing: missingKeys, originalHeaders: rawHeaders };
        }

        function processData(csvContent) {
            console.log('Iniciando processamento inteligente do CSV...');
            els.fileStatus.className = 'text-sm text-slate-400 mt-4';
            els.ignoredRowsModal.overlay.classList.add('hidden');

            if (!csvContent || !csvContent.trim()) {
                handleDataLoadError('Arquivo vazio.');
                return;
            }

            if (csvContent.charCodeAt(0) === 0xFEFF) {
                csvContent = csvContent.slice(1);
            }

            const lines = csvContent.trim().split(/\r\n|\n|\r/);
            if (lines.length < 2) {
                handleDataLoadError('Arquivo contém apenas cabeçalho ou está vazio.');
                return;
            }

            const delimiter = detectDelimiter(lines[0]);
            if (!delimiter) {
                handleDataLoadError('Não foi possível detectar o separador de colunas (vírgula, ponto e vírgula ou tabulação).');
                return;
            }
            console.log(`Delimitador detectado: "${delimiter === '\t' ? 'TAB' : delimiter}"`);

            const rawHeaders = splitCsvLine(lines[0], delimiter);
            const mappingResult = mapHeaders(rawHeaders);

            if (mappingResult.missing.length > 0) {
                const missingNames = mappingResult.missing.map(k => COLUMN_ALIASES[k].join(' ou ')).join('; \n');
                handleDataLoadError(`Não foi possível encontrar colunas correspondentes a:\n${missingNames}.\nVerifique os cabeçalhos do seu CSV.`);
                return;
            }

            const map = mappingResult.map;
            let ignoredRowsDetails = [];

            originalData = lines.slice(1).map((line, index) => {
                const currentLineNumber = index + 2;
                const values = splitCsvLine(line, delimiter);

                if (values.length !== rawHeaders.length) {
                    ignoredRowsDetails.push({ lineNumber: currentLineNumber, reason: 'Número de colunas diferente do cabeçalho', columnName: 'Linha Completa', columnValue: line.substring(0, 150) + (line.length > 150 ? '...' : '') });
                    return null;
                }

                const rawDuration = values[map.DURACAO];
                const durationMinutes = parseDurationToMinutes(rawDuration);
                const dateRawValue = values[map.DATA_INICIO];
                const dateObj = parseDateTimeRobust(dateRawValue);
                const consultorRawValue = values[map.CONSULTOR];
                const consultor = normalizeDataString(consultorRawValue);
                const tipoRawValue = values[map.TIPO];
                const tipo = toTitleCase(normalizeDataString(tipoRawValue));

                let rowProblem = null;
                if (!dateObj) rowProblem = { reason: `Data/Hora de Início inválida ou vazia`, columnName: rawHeaders[map.DATA_INICIO], columnValue: dateRawValue };
                else if (durationMinutes <= 0) rowProblem = { reason: `Duração da pausa inválida ou zero`, columnName: rawHeaders[map.DURACAO], columnValue: rawDuration };
                else if (consultor === 'Não informado' || consultorRawValue.trim() === '') rowProblem = { reason: `Nome do Consultor não informado`, columnName: rawHeaders[map.CONSULTOR], columnValue: consultorRawValue };
                else if (tipo === 'Não informado' || tipoRawValue.trim() === '') rowProblem = { reason: `Tipo de Pausa não informado`, columnName: rawHeaders[map.TIPO], columnValue: tipoRawValue };

                if (rowProblem) {
                    ignoredRowsDetails.push({ lineNumber: currentLineNumber, ...rowProblem });
                    return null;
                }

                return { CONSULTOR: consultor, TIPO: tipo, DURACAO_MINUTES: durationMinutes, DATA_INICIO_OBJ: dateObj, _raw: { duration: rawDuration, date: dateRawValue } };
            }).filter(row => row !== null);

            if (originalData.length === 0) {
                if (ignoredRowsDetails.length > 0) showIgnoredRowsPopup(ignoredRowsDetails);
                handleDataLoadError('Nenhuma linha de dados válida encontrada após o processamento.');
                return;
            }

            const dates = originalData.map(d => d.DATA_INICIO_OBJ);
            els.filters.startDate.value = formatDateToYYYYMMDD(new Date(Math.min(...dates)));
            els.filters.endDate.value = formatDateToYYYYMMDD(new Date(Math.max(...dates)));

            filteredData = [...originalData];
            populateFilters();
            enableDashboardControls(true);

            let statusMsg = `Sucesso! Separador: [${delimiter === '\t' ? 'TAB' : delimiter}]. Carregados ${originalData.length} registros.`;
            if (ignoredRowsDetails.length > 0) {
                statusMsg += ` (${ignoredRowsDetails.length} linhas ignoradas).`;
                showIgnoredRowsPopup(ignoredRowsDetails);
            }

            els.fileStatus.textContent = statusMsg;
            els.fileStatus.className = 'text-sm text-green-400 mt-4 font-medium';
            updateDashboard();
        }

        function loadMockApiData() {
            els.fileInput.value = '';
            els.fileStatus.textContent = 'Carregando dados de exemplo...';
            els.fileStatus.className = 'text-sm text-slate-400 mt-4';

            const names = ['Ana Silva', 'Carlos Souza', 'Beatriz Costa', 'Daniel Oliveira'];
            const types = ['Almoço', 'Café', 'Reunião', 'Treinamento', 'Banheiro', 'Feedback', 'Formalização', 'Negociação', 'Cadastrando Proposta', 'Intervalo'];
            const baseDate = new Date();
            baseDate.setHours(8, 0, 0, 0);

            originalData = [];
            for (let i = 0; i < 150; i++) {
                const name = names[Math.floor(Math.random() * names.length)];
                const type = types[Math.floor(Math.random() * types.length)];
                let duration;

                const expected = EXPECTED_DURATIONS[type];
                if (expected) {
                    if (Math.random() < 0.8) {
                        duration = expected.minutes + (Math.random() * (expected.tolerance * 2) - expected.tolerance);
                    } else {
                        duration = expected.minutes + (Math.random() * 20 - 10);
                    }
                } else {
                    duration = Math.floor(Math.random() * 55) + 5;
                }

                duration = Math.max(1, Math.round(duration));

                const entryDate = new Date(baseDate);
                entryDate.setDate(baseDate.getDate() + Math.floor(i / 20));
                entryDate.setMinutes(entryDate.getMinutes() + (i * 25) + Math.random()*120);

                originalData.push({ CONSULTOR: name, TIPO: type, DURACAO_MINUTES: duration, DATA_INICIO_OBJ: entryDate });
            }

            const dates = originalData.map(d => d.DATA_INICIO_OBJ);
            els.filters.startDate.value = formatDateToYYYYMMDD(new Date(Math.min(...dates)));
            els.filters.endDate.value = formatDateToYYYYMMDD(new Date(Math.max(...dates)));

            filteredData = [...originalData];
            populateFilters();
            enableDashboardControls(true);
            els.fileStatus.textContent = `Dados de exemplo carregados (${originalData.length} registros).`;
            els.fileStatus.className = 'text-sm text-blue-400 mt-4 font-medium';
            updateDashboard();
        }

        function handleDataLoadError(msg) {
            console.error(msg);
            els.fileStatus.textContent = `Erro: ${msg}`;
            els.fileStatus.className = 'text-sm text-red-400 mt-4 font-bold';
            originalData = [];
            filteredData = [];
            enableDashboardControls(false);
            updateDashboard();
        }

        // --- Lógica do Dashboard ---
        function populateFilters() {
            const consultants = [...new Set(originalData.map(d => d.CONSULTOR))].sort();
            const pauseTypes = [...new Set(originalData.map(d => d.TIPO))].sort();

            const consultantFilter = els.filters.consultant;
            consultantFilter.innerHTML = '<option value="">Todos</option>'; // Limpa opções anteriores
            consultants.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                consultantFilter.appendChild(option);
            });

            const pauseTypeFilter = els.filters.pauseType;
            pauseTypeFilter.innerHTML = '<option value="">Todos</option>'; // Limpa opções anteriores
            pauseTypes.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                pauseTypeFilter.appendChild(option);
            });
        }

        function enableDashboardControls(enable) {
            Object.values(els.filters).forEach(el => el.disabled = !enable);
            els.buttons.clearFilters.disabled = !enable;
            if (!enable) {
                els.buttons.generateAi.disabled = true;
                els.ai.section.classList.add('hidden');
            }
        }

        function applyFilters() {
            const selConsultant = els.filters.consultant.value;
            const selType = els.filters.pauseType.value;

            let startDate = null, endDate = null;
            if (els.filters.startDate.value) {
                startDate = new Date(els.filters.startDate.value);
                startDate = new Date(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate(), 0,0,0);
            }
            if (els.filters.endDate.value) {
                endDate = new Date(els.filters.endDate.value);
                endDate = new Date(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate(), 23, 59, 59, 999);
            }

            filteredData = originalData.filter(d => {
                const matchConsultant = !selConsultant || d.CONSULTOR === selConsultant;
                const matchType = !selType || d.TIPO === selType;
                let matchDate = true;
                if (startDate) matchDate = matchDate && d.DATA_INICIO_OBJ >= startDate;
                if (endDate) matchDate = matchDate && d.DATA_INICIO_OBJ <= endDate;
                return matchConsultant && matchType && matchDate;
            });

            const contextData = originalData.filter(d => {
                const matchType = !selType || d.TIPO === selType;
                let matchDate = true;
                if (startDate) matchDate = matchDate && d.DATA_INICIO_OBJ >= startDate;
                if (endDate) matchDate = matchDate && d.DATA_INICIO_OBJ <= endDate;
                return matchType && matchDate;
            });

            filteredAveragesForComparison = {};
            const totals = {};
            const counts = {};
            contextData.forEach(d => {
                totals[d.TIPO] = (totals[d.TIPO] || 0) + d.DURACAO_MINUTES;
                counts[d.TIPO] = (counts[d.TIPO] || 0) + 1;
            });
            for (const type in totals) {
                filteredAveragesForComparison[type] = totals[type] / counts[type];
            }

            const canUseAI = selConsultant && !selType;
            els.buttons.generateAi.disabled = !canUseAI;

            if (!canUseAI) els.ai.section.classList.add('hidden');

            updateDashboard();
        }

        function updateDashboard() {
            renderKPIs();
            renderCharts();
            if (tabulatorTable) {
                tabulatorTable.setData(filteredData);
            }
        }

        // --- Renderização ---
        function renderKPIs() {
            let totalMin = 0;
            const uniqueCons = new Set();
            filteredData.forEach(d => {
                totalMin += d.DURACAO_MINUTES;
                uniqueCons.add(d.CONSULTOR);
            });
            animateValue(els.kpis.totalPauses, parseInt(els.kpis.totalPauses.innerText) || 0, filteredData.length, 500);
            els.kpis.totalDuration.textContent = formatMinutesToHHMM(totalMin);
            animateValue(els.kpis.uniqueConsultants, parseInt(els.kpis.uniqueConsultants.innerText) || 0, uniqueCons.size, 500);
        }

        function animateValue(obj, start, end, duration) {
            if (start === end) { obj.innerText = end; return; }
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerText = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    obj.innerText = end;
                }
            };
            window.requestAnimationFrame(step);
        }

        function aggregateData(key) {
            const agg = {};
            filteredData.forEach(d => {
                agg[d[key]] = (agg[d[key]] || 0) + d.DURACAO_MINUTES;
            });
            return agg;
        }

        function aggregateAverage(key) {
            const totals = {};
            const counts = {};
            filteredData.forEach(d => {
                totals[d[key]] = (totals[d[key]] || 0) + d.DURACAO_MINUTES;
                counts[d[key]] = (counts[d[key]] || 0) + 1;
            });
            const avgs = {};
            for(const k in totals) avgs[k] = totals[k] / counts[k];
            return avgs;
        }

        function createChart(canvasId, chartInstanceVar, type, labels, data, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[chartInstanceVar]) charts[chartInstanceVar].destroy();

            const chartColors = {
                'doughnut': ['#60A5FA', '#4ADE80', '#FACC15', '#F87171', '#A78BFA', '#F472B6', '#9CA3AF'],
                'barDefault': 'rgba(96, 165, 250, 0.7)', // blue-400
            };

            const backgroundColor = type === 'doughnut' ? chartColors.doughnut : color || chartColors.barDefault;

            const config = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: type === 'doughnut' ? '#0B1120' : 'transparent',
                        borderWidth: type === 'doughnut' ? 3 : 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: type === 'doughnut',
                            position: 'right',
                            labels: {
                                color: '#cbd5e1' // slate-300
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let val = context.raw;
                                    let lbl = context.label || '';
                                    if (lbl) lbl += ': ';
                                    if (type === 'doughnut') {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const perc = total > 0 ? ((val / total) * 100).toFixed(1) + '%' : '0%';
                                        return `${lbl}${formatMinutesToHHMM(val)} (${perc})`;
                                    }
                                    return lbl + formatMinutesToHHMM(val) + ` (${val.toFixed(1)} min)`;
                                }
                            }
                        }
                    },
                    scales: (type === 'bar') ? {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' } // slate-400
                        },
                        x: {
                            grid: { color: 'transparent' },
                            ticks: { color: '#94a3b8' } // slate-400
                        }
                    } : {}
                }
            };

            charts[chartInstanceVar] = new Chart(ctx, config);
        }

        function renderCharts() {
            const consData = aggregateData('CONSULTOR');
            const consLabels = Object.keys(consData).sort();
            createChart('total-pause-consultant-chart', 'consultantTotal', 'bar', consLabels, consLabels.map(k => consData[k]), 'Total Duração', 'rgba(167, 139, 250, 0.7)'); // purple-400

            const typeData = aggregateData('TIPO');
            const typeLabels = Object.keys(typeData).sort();
            createChart('total-pause-type-chart', 'typeTotal', 'bar', typeLabels, typeLabels.map(k => typeData[k]), 'Total Duração', 'rgba(74, 222, 128, 0.7)'); // green-400

            const typeAvgData = aggregateAverage('TIPO');
            const avgChartData = typeLabels.map(type => typeAvgData[type] || 0);
            createChart('average-pause-type-chart', 'typeAverage', 'bar', typeLabels, avgChartData, 'Média Duração', 'rgba(250, 204, 21, 0.7)'); // yellow-400

            createChart('pause-type-distribution-chart', 'typeDistribution', 'doughnut', typeLabels, typeLabels.map(k => typeData[k]), 'Distribuição', null);
        }

        // --- Integração IA (Gemini) ---
        async function generateAIAnalysis() {
            const uniqueConsultants = [...new Set(filteredData.map(d => d.CONSULTOR))];
            if (uniqueConsultants.length !== 1) {
                console.log("AI Analysis skipped: not exactly one consultant selected.");
                return;
            }
            const consultant = uniqueConsultants[0];

            els.ai.section.classList.remove('hidden');
            els.ai.placeholder.classList.add('hidden');
            els.ai.loading.classList.remove('hidden');
            els.ai.content.innerHTML = '';
            els.ai.section.scrollIntoView({ behavior: 'smooth' });

            const totalPausas = filteredData.length;
            const totalMinutos = filteredData.reduce((sum, d) => sum + d.DURACAO_MINUTES, 0);

            const typeStats = {};
            filteredData.forEach(d => {
                if(!typeStats[d.TIPO]) typeStats[d.TIPO] = { total: 0, count: 0 };
                typeStats[d.TIPO].total += d.DURACAO_MINUTES;
                typeStats[d.TIPO].count++;
            });

            let dataText = `Consultor: ${consultant}\nPeríodo: ${els.filters.startDate.value} a ${els.filters.endDate.value}\nTotal Pausas: ${totalPausas}, Tempo Total: ${formatMinutesToHHMM(totalMinutos)}\n\nDetalhamento por Tipo:\n`;

            for(const type in typeStats) {
                const stats = typeStats[type];
                const avg = stats.total / stats.count;
                const contextAvg = filteredAveragesForComparison[type] || 0;
                let statusDescription = '';
                const expected = EXPECTED_DURATIONS[type];
                if (expected) {
                    const lowerBound = expected.minutes - expected.tolerance;
                    const upperBound = expected.minutes + expected.tolerance;
                    if (avg >= lowerBound && avg <= upperBound) statusDescription = `(duração ideal: ${expected.minutes}min - Média OK)`;
                    else if (avg < lowerBound) statusDescription = `(duração ideal: ${expected.minutes}min - Média Curta)`;
                    else statusDescription = `(duração ideal: ${expected.minutes}min - Média Longa)`;
                } else {
                    const diffPerc = contextAvg > 0 ? ((avg - contextAvg) / contextAvg) * 100 : 0;
                    if (diffPerc > 10) statusDescription = `(Média da Equipe: ${contextAvg.toFixed(1)}min, ACIMA da média da equipe +${diffPerc.toFixed(0)}%)`;
                    else if (diffPerc < -10) statusDescription = `(Média da Equipe: ${contextAvg.toFixed(1)}min, ABAIXO da média da equipe ${diffPerc.toFixed(0)}%)`;
                    else statusDescription = `(Média da Equipe: ${contextAvg.toFixed(1)}min, na média da equipe)`;
                }
                dataText += `- ${type}: ${stats.count}x, Total: ${formatMinutesToHHMM(stats.total)}, Média: ${avg.toFixed(1)}min ${statusDescription}.\n`;
            }

            const prompt = `
                Aja como um analista de performance sênior de call center. Analise os dados de pausas abaixo para o consultor.
                As seguintes regras de negócio *fixas* devem ser consideradas como padrão da operação:
                - Pausa para Almoço: 60 minutos (1 hora).
                - Pausa para Café ou Intervalo: 15 minutos.
                - Pausa para Banheiro: 10 minutos.
                - Pausa para Negociação: 15 minutos.
                - Cadastrando Proposta: 10 minutos.
                Para outros tipos de pausas não listados acima, compare a média do consultor com a média geral da equipe no período filtrado para identificar desvios.
                Dados:\n${dataText}\n
                Instruções:
                1. Crie um resumo executivo curto (máx 3 linhas) sobre o comportamento de pausas do consultor, mantendo tom profissional.
                2. Destaque 1 ponto positivo e 1 ponto de atenção principal.
                3. Dê 2 sugestões práticas e diretas para o gestor aplicar com este consultor.
                Use formatação Markdown (negrito para destaques). Seja conciso.
            `;

            try {
                // ATENÇÃO: A chave de API abaixo é apenas para fins de demonstração e pode estar desativada.
                // Substitua pela sua própria chave de API do Google AI Studio.
                const apiKey = "AIzaSyAqzAYVdmYUGqfEGr8TvsgDxMWmPdc0-XU"; // Exemplo de chave, substitua
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `Erro API IA: ${response.status}`);
                }
                const data = await response.json();
                const aiText = data.candidates[0]?.content?.parts[0]?.text;
                if (!aiText) throw new Error('Resposta da IA vazia ou malformada.');
                const htmlText = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                els.ai.content.innerHTML = `<div class="prose prose-invert max-w-none">${htmlText}</div>`;
            } catch (error) {
                console.error(error);
                els.ai.content.innerHTML = `<p class="text-red-400 font-medium">Falha ao gerar análise. (${error.message})</p>`;
            } finally {
                els.ai.loading.classList.add('hidden');
            }
        }

        // --- Funções do Modal de Erros ---
        function showIgnoredRowsPopup(errors) {
            els.ignoredRowsModal.list.innerHTML = '';
            errors.forEach(err => {
                const li = document.createElement('li');
                li.className = 'error-item';
                li.innerHTML = `<p><strong>Linha ${err.lineNumber}:</strong> ${err.reason}</p><p>Campo: <span>${err.columnName || 'N/A'}</span>, Valor: <span>"${err.columnValue || 'Vazio'}"</span></p>`;
                els.ignoredRowsModal.list.appendChild(li);
            });
            els.ignoredRowsModal.overlay.classList.remove('hidden');
        }

        function hideIgnoredRowsPopup() {
            els.ignoredRowsModal.overlay.classList.add('hidden');
        }

        // --- Função para controlar a Sidebar ---
        function setupSidebar() {
            const toggleSidebar = () => {
                els.sidebar.menu.classList.toggle('-translate-x-full');
                els.sidebar.overlay.classList.toggle('hidden');
                els.mainContent.classList.toggle('lg:pl-80');
            };

            els.sidebar.toggleBtn.addEventListener('click', toggleSidebar);
            els.sidebar.overlay.addEventListener('click', toggleSidebar);
        }

        // --- Inicialização e Event Listeners ---
        function init() {
            setupSidebar();

            // Inicialização da Tabela com Tabulator
            tabulatorTable = new Tabulator("#pause-detail-table", {

                // **** CORREÇÃO APLICADA AQUI ****
                // Mantido theme: "bootstrap5" para usar as classes corretas
                theme: "bootstrap5", 

                height: "500px",
                layout: "fitData",
                placeholder: "<span class='text-slate-400'>Nenhum dado para exibir</span>",
                columns: [
                    { title: "Consultor", field: "CONSULTOR", headerFilter: "input", width: 150 },
                    { title: "Tipo de Pausa", field: "TIPO", headerFilter: "input" },
                    { title: "Data Início", field: "DATA_INICIO_OBJ", hozAlign: "center", width: 180, formatter: (cell) => formatDateTimeDisplay(cell.getValue()) },
                    { title: "Duração (HH:MM:SS)", field: "DURACAO_MINUTES", hozAlign: "center", formatter: (cell) => formatMinutesToHHMMSS(cell.getValue()) },
                    { title: "Duração (Min)", field: "DURACAO_MINUTES", hozAlign: "right", formatter: (c) => c.getValue().toFixed(1) },
                    { title: "Meta / Média (Min)", field: "TIPO", hozAlign: "right", formatter: (cell) => {
                        const type = cell.getValue();
                        const expected = EXPECTED_DURATIONS[type];
                        if (expected) return expected.minutes.toFixed(1);
                        const avg = filteredAveragesForComparison[type] || 0;
                        return avg.toFixed(1);
                    }},
                    { title: "Status", field: "DURACAO_MINUTES", hozAlign: "center", formatter: (cell) => {
                        const duration = cell.getValue();
                        const type = cell.getRow().getData().TIPO;
                        const expected = EXPECTED_DURATIONS[type];
                        let statusText = '';

                        if (expected) {
                            const lowerBound = expected.minutes - expected.tolerance;
                            const upperBound = expected.minutes + expected.tolerance;
                            if (duration >= lowerBound && duration <= upperBound) {
                                statusText = '<span class="text-green-400 font-medium">✓ Correto</span>';
                            } else if (duration < lowerBound) {
                                statusText = '<span class="text-yellow-400 font-semibold">↓ Curto</span>';
                            } else {
                                statusText = '<span class="text-red-400 font-semibold">↑ Longo</span>';
                            }
                        } else {
                            const avg = filteredAveragesForComparison[type] || 0;
                            const isAbove = duration > (avg * 1.1) && avg > 0;
                            statusText = isAbove
                                ? '<span class="text-red-400 font-semibold">↑ Acima</span>'
                                : '<span class="text-green-400 font-medium">✓ Normal</span>';
                        }
                        return statusText;
                    }}
                ],
                locale: "pt-br",
                langs:{
                    "pt-br":{
                        "headerFilters":{
                            "default":"filtrar...",
                        }
                    }
                }
            });

            // File Input
            els.fileInput.addEventListener('change', (e) => {
                hideIgnoredRowsPopup();
                const file = e.target.files[0];
                if (!file) {
                    els.fileNameDisplay.textContent = 'Nenhum...colhido';
                    return;
                }

                els.fileNameDisplay.textContent = file.name;
                els.fileStatus.textContent = `Lendo "${file.name}"...`;
                els.fileStatus.className = 'text-sm text-blue-400 mt-4 animate-pulse';

                const reader = new FileReader();
                reader.onload = (evt) => processData(evt.target.result);
                reader.onerror = () => handleDataLoadError('Falha ao ler o arquivo.');
                reader.readAsText(file, 'UTF-8');
            });

            // Buttons
            els.buttons.loadApi.addEventListener('click', loadMockApiData);
            els.buttons.clearFilters.addEventListener('click', () => {
                const dates = originalData.map(d => d.DATA_INICIO_OBJ);
                els.filters.startDate.value = '';
                els.filters.endDate.value = '';
                els.filters.consultant.value = '';
                els.filters.pauseType.value = '';
                applyFilters();
            });
            els.buttons.generateAi.addEventListener('click', generateAIAnalysis);
            els.buttons.closeAi.addEventListener('click', () => {
                els.ai.section.classList.add('hidden');
                els.ai.placeholder.classList.remove('hidden');
                els.ai.content.innerHTML = '';
            });

            // Filters
            const debouncedApplyFilters = debounce(applyFilters, 300);
            Object.values(els.filters).forEach(filter => {
                filter.addEventListener('change', debouncedApplyFilters);
            });

            // Modal de Erros
            els.ignoredRowsModal.closeBtn.addEventListener('click', hideIgnoredRowsPopup);
            els.ignoredRowsModal.overlay.addEventListener('click', (e) => {
                if (e.target === els.ignoredRowsModal.overlay) {
                    hideIgnoredRowsPopup();
                }
            });

            // Estado inicial
            enableDashboardControls(false);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>