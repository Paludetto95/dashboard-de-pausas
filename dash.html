<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise de Pausas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <style>
        /* --- 1. Paleta de Cores e Tema --- */
        :root {
            --bg-main: #1C1C24;
            --bg-container: #252532;
            --text-main: #F0F0F0;
            --text-secondary: #A0A0A0;
            --highlight-primary: #3A7FFF;
            --highlight-secondary-yellow: #FBC02D;
            --highlight-secondary-purple: #E040FB;
            --status-success: #00C853;
            --status-danger: #D50000;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-secondary);
        }

        /* --- 2. Tipografia e Hierarquia --- */
        h1 {
            font-size: 2.25rem;
            line-height: 2.5rem;
            font-weight: 800;
            color: var(--text-main);
        }

        h2 {
            font-size: 1.25rem;
            line-height: 1.75rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .kpi-value {
            font-size: 2.25rem;
            line-height: 2.5rem;
            font-weight: 700;
            color: var(--text-main);
        }
        
        .support-text {
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: 400;
            color: var(--text-secondary);
        }

        /* --- 3. Componentes e Layout --- */
        .card {
            background-color: var(--bg-container);
            padding: 2rem;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #sidebar .card {
             background-color: #2D2D3A;
             text-align: center;
        }

        #sidebar .card .flex.justify-between {
            text-align: left;
        }

        .btn {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            font-weight: 600;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }
        .btn-primary {
            background-color: var(--highlight-primary);
            color: var(--text-main);
        }
        .btn-primary:hover { filter: brightness(1.2); }
        .btn-danger {
            background-color: var(--status-danger);
            color: var(--text-main);
        }
        .btn-danger:hover { filter: brightness(1.2); }
        .btn-secondary {
            background-color: #4A4A58;
            color: var(--text-main);
        }
        .btn-secondary:hover { background-color: #5A5A68; }


        /* --- 4. Menu Lateral Expansível --- */
        #sidebar {
            transition: left 0.3s ease-in-out;
            left: -20rem; /* Esconde a sidebar (largura w-80 = 20rem) */
        }
        body.sidebar-open #sidebar {
            left: 0; /* Mostra a sidebar */
        }
        body.sidebar-open #sidebar-overlay {
            display: none; /* Esconde o overlay por padrão */
        }
        @media (max-width: 1023px) { /* Em telas pequenas, mostra o overlay quando a sidebar está aberta */
            body.sidebar-open #sidebar-overlay {
                display: block;
            }
        }
        body.sidebar-open #main-content {
            margin-left: 0; /* Garante que não há margin-left por padrão */
            position: relative; /* Necessário para z-index funcionar */
            z-index: 10; /* Garante que o main-content fique abaixo da sidebar */
        }
        #sidebar-open-btn { /* Visível por padrão */
            display: block;
        }
        body.sidebar-open #sidebar-open-btn { /* Esconde o botão de abrir quando a sidebar está aberta */
            display: none;
        }
        @media (max-width: 1023px) { /* Para telas menores, a sidebar ocupa a tela toda */
            body.sidebar-open #main-content {
                margin-left: 0; /* Não empurra o conteúdo em telas pequenas */
            }
        }
        
        .tab-button.active {
            background-color: var(--highlight-primary) !important;
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        /* --- Elementos Específicos do Dashboard --- */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        @media (min-width: 768px) { .chart-container { height: 350px; } }

        .form-input-dark {
            display: block;
            width: 100%;
            padding: 0.5rem 1rem 0.5rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            border-width: 0px;
            background-color: #2D2D3A;
            color: var(--text-main);
        }
        .form-input-dark:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: var(--highlight-primary);
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }
        .form-input-dark:disabled {
            background-color: #334155;
            opacity: 0.6;
        }
        
        .modal-overlay {
            position: fixed; inset: 0px; display: flex;
            justify-content: center; align-items: center;
            z-index: 1000; background-color: rgba(0, 0, 0, 0.8);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            background-color: var(--bg-container); padding: 2rem;
            border-radius: 1rem; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            max-width: 42rem; width: 90%; max-height: 80%;
            overflow-y: auto; position: relative;
        }
        .modal-close-btn {
            position: absolute; top: 1rem; right: 1rem;
            background: none; border: none; font-size: 1.5rem;
            cursor: pointer; color: var(--text-secondary);
        }
        .modal-close-btn:hover { color: var(--text-main); }
        .error-item {
            border-left-width: 4px; padding: 0.75rem; margin-bottom: 0.5rem;
            border-radius: 0.25rem; background-color: rgba(213, 0, 0, 0.2);
            border-color: var(--status-danger);
        }
        .error-item strong { color: #ff8a80; }
        .error-item span { color: #ffcdd2; }

        .spinner {
            width: 1.5em; height: 1.5em;
            border: 3px solid rgba(255, 255, 255, .2);
            border-radius: 50%; border-top-color: var(--highlight-primary);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Estilos da Tabela (Tabulator) --- */
        .tabulator {
            border: none; background-color:#252532;
        }
        .tabulator .tabulator-header {
            background-color: var(--bg-container) !important;
            border-bottom: 1px solid #4A4A58 !important;
        }
        .tabulator .tabulator-col, .tabulator .tabulator-col-content {
             background-color: transparent !important;
        }
        .tabulator .tabulator-col-title {
            color: var(--text-secondary) !important; font-weight: 500;
        }
        .tabulator .tabulator-header .tabulator-header-filter input {
            background-color: #1C1C24 !important; color: var(--text-main) !important;
            border: 1px solid #4A4A58 !important; border-radius: 8px !important;
            padding: 6px 10px !important;
        }
        .tabulator .tabulator-header .tabulator-header-filter input::placeholder {
             color: var(--text-secondary) !important; opacity: 0.7;
        }
        .tabulator .tabulator-tableHolder {
            background-color: #1C1C24 !important;
        }
        .tabulator .tabulator-placeholder span { color: white !important; }
        .tabulator .tabulator-row {
            background: #1C1C24; border-bottom: 1px solid #2D2D3A !important;
        }
        .tabulator .tabulator-row:hover .tabulator-cell {
            background-color: rgba(58, 127, 255, 0.1) !important;
        }
        .tabulator .tabulator-cell {
            color: var(--text-main) !important;
            border-right: 1px solid #2D2D3A !important;
            padding: 12px 10px !important;
        }
        .tabulator .tabulator-cell:last-of-type { border-right: none !important; }
        
        .tabulator .status-success { color: var(--status-success) !important; }
        .tabulator .status-danger { color: var(--status-danger) !important; }
        .tabulator .status-warning { color: var(--highlight-secondary-yellow) !important; }

        /* Scrollbar */
        ::-webkit-scrollbar { height: 10px; width: 10px; }
        ::-webkit-scrollbar-track { background: #1C1C24; }
        ::-webkit-scrollbar-thumb {
            background-color: #4A4A58; border-radius: 5px; border: 2px solid #1C1C24;
        }
    </style>
</head>
<body class="p-4 md:p-8 sidebar-open">
    <button onclick="exportarDadosParaHtml()" style="margin: 10px; padding: 8px 15px;">Exportar para HTML</button>

    <button id="sidebar-open-btn" class="fixed top-4 left-4 p-2 rounded-md text-white hover:bg-slate-700 transition-colors z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>
    
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 hidden"></div>
        <div class="flex flex-col gap-4">
            <!-- PAUSES CONTROLS -->
            <div id="pauses-sidebar-content" class="flex flex-col gap-4">
                <div class="card">
                    <h2 class="text-2xl font-semibold text-slate-100 mb-4 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span>Carregar Dados</span>
                    </h2>
                    <div class="flex flex-col gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Arquivo CSV</label>
                            <div class="flex justify-center">
                                <label id="file-upload-label" for="csv-file-input" class="w-full cursor-pointer px-4 py-2 bg-slate-700 text-white font-semibold rounded-lg shadow-md hover:bg-slate-600 transition duration-300 ease-in-out truncate text-center">
                                    Escolher arquivo
                                </label>
                                <input type="file" id="csv-file-input" accept=".csv, .txt, .tsv" class="hidden"/>
                            </div>
                        </div>

                        <hr class="border-slate-600">
                        
                        <div class="flex items-center justify-around mb-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="time-selection" value="periodo" class="form-radio text-teal-500" checked>
                                <span class="ml-2 text-slate-300">Período</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="time-selection" value="ultimosMinutos" class="form-radio text-teal-500">
                                <span class="ml-2 text-slate-300">Últimos Minutos</span>
                            </label>
                        </div>

                        <div id="periodo-inputs" class="space-y-3">
                            <label class="block text-sm font-medium text-slate-300 text-left">Período</label>
                            <div class="flex items-center gap-2">
                                <input type="date" id="api-start-date" class="form-input-dark w-full" required>
                                <input type="time" id="api-start-time" class="form-input-dark w-2/3" required>
                            </div>
                             <div class="flex items-center gap-2">
                                <input type="date" id="api-end-date" class="form-input-dark w-full" required>
                                <input type="time" id="api-end-time" class="form-input-dark w-2/3" required>
                            </div>
                        </div>

                        <div id="ultimos-minutos-inputs" class="space-y-2 hidden">
                            <label for="ultimos-minutos" class="block text-sm font-medium text-slate-300 text-left">Últimos Minutos</label>
                            <input type="number" id="ultimos-minutos" placeholder="Ex: 60" class="form-input-dark w-full">
                        </div>
                        
                        <button id="load-argus-api-btn" class="!mt-5 w-full px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 transition duration-300 ease-in-out">
                            Carregar via API (Argus)
                        </button>
                    </div>
                    <p id="file-status" class="text-sm text-slate-400 mt-4">Nenhum dado carregado.</p>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-semibold text-slate-100 mb-4 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                        <span>Filtros</span>
                    </h2>
                    <div class="flex flex-col gap-4">
                        <div class="flex justify-between items-center">
                            <label for="consultant-filter" class="text-sm font-medium text-slate-300">Consultor:</label>
                            <select id="consultant-filter" class="form-input-dark w-1/2" disabled>
                                <option value="">Todos</option>
                            </select>
                        </div>
                         <div class="flex justify-between items-center">
                            <label for="pause-type-filter" class="text-sm font-medium text-slate-300">Tipo de Pausa:</label>
                            <select id="pause-type-filter" class="form-input-dark w-1/2" disabled>
                                <option value="">Todos</option>
                            </select>
                        </div>
                         <div class="flex justify-between items-center">
                            <label for="start-date-filter" class="text-sm font-medium text-slate-300">Data Início:</label>
                            <input type="date" id="start-date-filter" class="form-input-dark w-1/2 date-input" data-placeholder="dd/mm/aaaa" disabled required>
                        </div>
                         <div class="flex justify-between items-center">
                            <label for="end-date-filter" class="text-sm font-medium text-slate-300">Data Fim:</label>
                            <input type="date" id="end-date-filter" class="form-input-dark w-1/2 date-input" data-placeholder="dd/mm/aaaa" disabled required>
                        </div>
                    </div>
                    <div class="flex flex-col gap-4 mt-6">
                        <button id="generate-ai-analysis-btn" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Gerar Análise com IA ✨
                        </button>
                        <button id="export-html-btn" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Exportar para HTML
                        </button>
                        <button id="clear-filters-btn" class="w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 ease-in-out" disabled>
                            Limpar Filtros
                        </button>
                    </div>
                </div>
            </div>

            <!-- TABULATIONS CONTROLS -->
            <div id="tabulations-sidebar-content" class="hidden flex flex-col gap-4">
                <div class="card">
                    <h2 class="text-2xl font-semibold text-slate-100 mb-4 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span>Carregar Dados de Tabulações</span>
                    </h2>
                    <div class="flex flex-col gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Arquivo CSV de Tabulações</label>
                            <div class="flex justify-center">
                                <label id="call-tabulations-file-upload-label" for="call-tabulations-csv-file-input" class="w-full cursor-pointer px-4 py-2 bg-slate-700 text-white font-semibold rounded-lg shadow-md hover:bg-slate-600 transition duration-300 ease-in-out truncate text-center">
                                    Escolher arquivo
                                </label>
                                <input type="file" id="call-tabulations-csv-file-input" accept=".csv, .txt, .tsv" class="hidden"/>
                            </div>
                        </div>
                        <p id="call-tabulations-file-status" class="text-sm text-slate-400 mt-4">Nenhum dado carregado.</p>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-semibold text-slate-100 mb-4 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                        <span>Filtros de Tabulações</span>
                    </h2>
                    <div class="flex flex-col gap-4">
                        <div class="flex justify-between items-center">
                            <label for="tabulation-operator-filter" class="text-sm font-medium text-slate-300">Operador:</label>
                            <select id="tabulation-operator-filter" class="form-input-dark w-1/2" disabled>
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="tabulation-type-filter" class="text-sm font-medium text-slate-300">Tipo de Tabulação:</label>
                            <select id="tabulation-type-filter" class="form-input-dark w-1/2" disabled>
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="tabulation-category-filter" class="text-sm font-medium text-slate-300">Categoria:</label>
                            <select id="tabulation-category-filter" class="form-input-dark w-1/2" disabled>
                                <option value="">Todas</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="tabulation-start-date-filter" class="text-sm font-medium text-slate-300">Data Início:</label>
                            <input type="date" id="tabulation-start-date-filter" class="form-input-dark w-1/2 date-input" data-placeholder="dd/mm/aaaa" disabled required>
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="tabulation-end-date-filter" class="text-sm font-medium text-slate-300">Data Fim:</label>
                            <input type="date" id="tabulation-end-date-filter" class="form-input-dark w-1/2 date-input" data-placeholder="dd/mm/aaaa" disabled required>
                        </div>
                    </div>
                    <div class="flex flex-col gap-4 mt-6">
                        <button id="clear-tabulation-filters-btn" class="w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 ease-in-out" disabled>
                            Limpar Filtros
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <main id="main-content">
        <div class="container mx-auto">
            <h1 class="text-4xl font-extrabold text-white mb-4 text-center">
                Dashboard de Análise
            </h1>
            <div class="flex justify-center mb-8 space-x-4">
                <button id="tab-pauses-btn" class="tab-button active px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out">
                    Pausas
                </button>
                <button id="tab-call-tabulations-btn" class="tab-button px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition duration-300 ease-in-out">
                    Tabulações de Ligações
                </button>
            </div>

            <div id="pauses-dashboard-content">
    
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card">
                    <p class="text-sm font-medium text-slate-400">Pausas Registradas</p>
                    <p id="kpi-total-pauses" class="text-4xl font-bold text-blue-400 mt-2">0</p>
                </div>
                <div class="card">
                    <p class="text-sm font-medium text-slate-400">Total Global de Pausa</p>
                    <p id="kpi-total-global-pause" class="text-4xl font-bold text-green-400 mt-2">00:00</p>
                </div>
                <div class="card">
                    <p class="text-sm font-medium text-slate-400">Consultores Únicos</p>
                    <p id="kpi-unique-consultants" class="text-4xl font-bold text-purple-400 mt-2">0</p>
                </div>
            </div>
    
            <div class="flex flex-col gap-6">
                <div id="ai-analysis-section" class="card hidden">
                    <h2 class="text-2xl font-semibold text-slate-100 mb-4">Análise de Pausas com IA</h2>
                    <div id="ai-analysis-content" class="bg-slate-900/50 p-4 rounded-lg text-slate-300 leading-relaxed min-h-[100px] flex items-center justify-center">
                        <p id="ai-loading-message" class="hidden text-center text-slate-400 flex items-center justify-center">
                            <div class="spinner mr-2"></div> Gerando análise... por favor, aguarde.
                        </p>
                        <p id="ai-placeholder-message" class="text-center text-slate-400">
                            Selecione um consultor e um período (opcional) e clique em "Gerar Análise com IA ✨" para ver um resumo personalizado.
                        </p>
                    </div>
                    <button id="close-ai-analysis-btn" class="mt-4 px-4 py-2 bg-slate-600 text-slate-100 font-semibold rounded-lg shadow-md hover:bg-slate-700 transition duration-300 ease-in-out">
                        Fechar Análise
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <h2 class="text-xl font-semibold text-slate-200 mb-4">Total de Duração por Consultor</h2>
                        <div class="chart-container">
                            <canvas id="total-pause-consultant-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-slate-200 mb-4">Total de Duração por Tipo</h2>
                        <div class="chart-container">
                            <canvas id="total-pause-type-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-slate-200 mb-4">Média de Duração por Tipo</h2>
                        <div class="chart-container">
                            <canvas id="average-pause-type-chart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-slate-200 mb-4">Distribuição do Tempo por Tipo</h2>
                        <div class="chart-container">
                            <canvas id="pause-type-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="text-2xl font-semibold text-slate-100 mb-4">Detalhes das Pausas</h2>
                    <div id="pause-detail-table" data-bs-theme="dark" class="table-dark"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="call-tabulations-dashboard-content" class="hidden">
        <h2 class="text-3xl font-extrabold text-white mb-8 text-center">Análise de Tabulações de Ligações</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card">
                <h2 class="text-xl font-semibold text-slate-200 mb-4">Total de Tabulações por Operador</h2>
                <div class="chart-container">
                    <canvas id="total-tabulations-operator-chart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-xl font-semibold text-slate-200 mb-4">Total de Tabulações por Tipo</h2>
                <div class="chart-container">
                    <canvas id="total-tabulations-type-chart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-xl font-semibold text-slate-200 mb-4">Total de Tabulações por Categoria</h2>
                <div class="chart-container">
                    <canvas id="total-tabulations-category-chart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 class="text-xl font-semibold text-slate-200 mb-4">Distribuição de Tabulações por Tipo</h2>
                <div class="chart-container">
                    <canvas id="tabulation-type-distribution-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="text-2xl font-semibold text-slate-100 mb-4">Detalhes das Tabulações</h2>
            <div id="call-tabulations-detail-table" data-bs-theme="dark" class="table-dark"></div>
        </div>
    </div>
</main>

    <div id="ignored-rows-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="close-ignored-rows-modal-btn" class="modal-close-btn">&times;</button>
            <h3 class="text-xl font-bold text-red-400 mb-4">⚠️ <span id="ignored-rows-count">0</span> Linhas Ignoradas no CSV</h3>
            <p class="text-slate-300 mb-4">As seguintes linhas foram ignoradas devido a dados inválidos ou ausentes. Por favor, revise seu arquivo CSV.</p>
            <ul id="ignored-rows-list" class="space-y-2"></ul>
        </div>
    </div>


    <script>
        // --- Configuração Global ---
        let geminiApiKey = null;        const COLUMN_ALIASES = {
            'GRUPO_OPERACIONAL': ['GRUPO OPERACIONAL', 'GRUPO OP'],
            'OPERADOR': ['OPERADOR', 'CONSULTOR', 'NOME DO OPERADOR', 'NOME OPERADOR'],
            'ESTADO': ['ESTADO'],
            'DESCRICAO_PAUSA': ['DESCRICAO DA PAUSA', 'DESCRIÇÃO DA PAUSA', 'TIPO PAUSA', 'TIPO_PAUSA', 'PAUSA', 'MOTIVO PAUSA', 'MOTIVO_PAUSA'],
            'DATA_INICIO': ['INICIO', 'DATA INICIO', 'DATA_INICIO', 'DATA_HORA_INICIO', 'DATA HORA INICIO'],
            'DATA_FIM': ['FIM', 'DATA FIM', 'DATA_FIM', 'DATA_HORA_FIM', 'DATA HORA FIM'],
            'TEMPO_PAUSA': ['TEMPO', 'TEMPO PAUSA', 'TEMPO_PAUSA', 'TEMPO_TOTAL_PAUSA', 'TEMPO TOTAL PAUSA'],
            'INICIO_LIVRE': ['INICIO EM LIVRE'],
            'SEGUNDOS_EM_LIVRE': ['SEGUNDOS EM LIVRE'],
            'DURACAO_ESPERADA': ['DURACAO ESPERADA', 'DURACAO_ESPERADA']
        };

        const columnAliasesCallTabulations = {
            'NR_LEAD': ['NR. LEAD', 'NR.LEAD', 'NR LEAD', 'NR_LEAD', 'LEAD'],
            'DATA_HORA_TABULACAO': ['DATA/HORA TABULAÇÃO', 'DATA/HORA_TABULACAO', 'DATA HORA TABULACAO', 'DATA_HORA_TABULACAO', 'DATA', 'HORA', 'DATA E HORA'],
            'TIPO_AGENDA': ['TIPO AGENDA (SALVOU)', 'TIPO_AGENDA', 'AGENDA'],
            'TABULADO_COMO': ['TABULADO COMO', 'TABULADO_COMO', 'STATUS'],
            'CATEGORIA_TABULACAO': ['CATEGORIA TABULAÇÃO', 'CATEGORIA_TABULACAO', 'CATEGORIA'],
            'OPERADOR': ['OPERADOR', 'CONSULTOR', 'NOME DO OPERADOR', 'NOME OPERADOR'],
            'COD_LOTE': ['CÓD. LOTE', 'COD. LOTE', 'COD LOTE', 'COD_LOTE', 'LOTE ID'],
            'LOTE': ['LOTE', 'DESCRICAO LOTE'],
            'NOME_CLIENTE': ['NOME DO CLIENTE', 'NOME_CLIENTE', 'CLIENTE'],
            'DATA_IMPORTACAO': ['DATA IMPORTAÇÃO', 'DATA_IMPORTACAO', 'IMPORTACAO'],
            'CPF_CNPJ': ['CPF / CNPJ', 'CPF/CNPJ', 'CPF_CNPJ', 'DOCUMENTO'],
            'COD_CLIENTE': ['CÓD. CLIENTE', 'COD. CLIENTE', 'COD CLIENTE', 'COD_CLIENTE', 'ID CLIENTE'],
            'TELEFONE': ['TELEFONE', 'FONE'],
            'ORIGEM_TABULACAO': ['ORIGEM TABULAÇÃO', 'ORIGEM_TABULACAO', 'ORIGEM'],
            'ORIGEM_POPUP': ['ORIGEM POPUP', 'ORIGEM_POPUP'],
            'GRUPO_USUARIO': ['GRUPO USUÁRIO', 'GRUPO_USUARIO'],
            'INFORMACAO_ATENDIMENTO': ['INFORMAÇÃO DO ATENDIMENTO', 'INFORMACAO_ATENDIMENTO'],
        };
        
        const expectedDurations = {
            'Almoço': { minutes: 60, tolerance: 3 },
            'Café': { minutes: 15, tolerance: 2 },
            'Intervalo': { minutes: 15, tolerance: 2 },
            'Pausa Intervalo': { minutes: 15, tolerance: 2 },
            'Banheiro': { minutes: 10, tolerance: 3 },
            'Negociação': { minutes: 15, tolerance: 3 },
            'Em Negociação': { minutes: 15, tolerance: 3 },
            'Cadastrando Proposta': { minutes: 5, tolerance: 2 },
            'Pesquisando Lead': { minutes: 5, tolerance: 2 },
            'Novo Lead': { minutes: 5, tolerance: 2 }
        };

        // Objeto unificado para seletores do DOM
        const els = {
            main: {
                tabPausasBtn: document.getElementById('tab-pauses-btn'),
                tabCallTabulationsBtn: document.getElementById('tab-call-tabulations-btn'),
                pausesDashboardContent: document.getElementById('pauses-dashboard-content'),
                fileInput: document.getElementById('csv-file-input'),
                fileUploadLabel: document.getElementById('file-upload-label'),
                fileStatus: document.getElementById('file-status'),
                pauseDetailsTable: null,
                buttons: {
                    loadArgusApi: document.getElementById('load-argus-api-btn'),
                    generateAi: document.getElementById('generate-ai-analysis-btn'),
                    clearFilters: document.getElementById('clear-filters-btn'),
                    closeAi: document.getElementById('close-ai-analysis-btn'),
                },
                filters: {
                    consultant: document.getElementById('consultant-filter'),
                    pauseType: document.getElementById('pause-type-filter'),
                    startDate: document.getElementById('start-date-filter'),
                    endDate: document.getElementById('end-date-filter'),
                },
                apiControls: {
                    startDate: document.getElementById('api-start-date'),
                    endDate: document.getElementById('api-end-date'),
                    startTime: document.getElementById('api-start-time'),
                    endTime: document.getElementById('api-end-time'),
                    ultimosMinutos: document.getElementById('ultimos-minutos'),
                },
                kpis: {
                    totalPauses: document.getElementById('kpi-total-pauses'),
                    totalDuration: document.getElementById('kpi-total-global-pause'),
                    uniqueConsultants: document.getElementById('kpi-unique-consultants')
                },
                ai: {
                    section: document.getElementById('ai-analysis-section'),
                    content: document.getElementById('ai-analysis-content'),
                    loading: document.getElementById('ai-loading-message'),
                    placeholder: document.getElementById('ai-placeholder-message')
                },
                ignoredRowsModal: {
                    modal: document.querySelector('#ignored-rows-modal-overlay .modal-content'),
                    closeBtn: document.getElementById('close-ignored-rows-modal-btn'),
                    overlay: document.getElementById('ignored-rows-modal-overlay'),
                    count: document.getElementById('ignored-rows-count'),
                    list: document.getElementById('ignored-rows-list')
                }
            },
            callTabulations: {
                dashboardContent: document.getElementById('call-tabulations-dashboard-content'),
                fileInput: document.getElementById('call-tabulations-csv-file-input'),
                fileUploadLabel: document.getElementById('call-tabulations-file-upload-label'),
                fileStatus: document.getElementById('call-tabulations-file-status'),
                tableContainer: document.getElementById('call-tabulations-detail-table'),
                filters: {
                     operator: document.getElementById('tabulation-operator-filter'),
                     type: document.getElementById('tabulation-type-filter'),
                     category: document.getElementById('tabulation-category-filter'),
                     startDate: document.getElementById('tabulation-start-date-filter'),
                     endDate: document.getElementById('tabulation-end-date-filter'),
                },
                buttons: {
                    clearFilters: document.getElementById('clear-tabulation-filters-btn'),
                }
                // Adicionar seletores para KPIs e Modal de erros de tabulações se/quando forem implementados no HTML
            }
        };

        let originalData = [];
        let filteredData = [];
        let callTabulationsOriginalData = [];
        let callTabulationsFilteredData = [];

        let tabulatorTable = null;
        let callTabulationsTable = null;
        let filteredAveragesForComparison = {};

        let charts = {
            consultantTotal: null,
            typeTotal: null,
            typeAverage: null,
            typeDistribution: null,
            tabulationOperatorTotal: null,
            tabulationTypeTotal: null,
            tabulationCategoryTotal: null,
            tabulationTypeDistribution: null
        };

        // --- Funções Utilitárias ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        function parseDurationToMinutes(durationStr) {
            if (!durationStr) return 0;
            const cleanStr = durationStr.trim().replace(/^"|"$/g, '');
            const parts = cleanStr.split(':').map(Number);
            if (parts.length === 3) { return parts[0] * 60 + parts[1] + parts[2] / 60; }
            else if (parts.length === 2) { return parts[0] * 60 + parts[1]; }
            return 0;
        }
        function formatMinutesToHHMM(totalMinutes) {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '00:00';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }
        function formatMinutesToHHMMSS(totalMinutes) {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '00:00:00';
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.floor(totalMinutes % 60);
            const seconds = Math.round((totalMinutes - Math.floor(totalMinutes)) * 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        function normalizeHeader(str) {
            if (typeof str !== 'string') return '';
            return str.toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g, '').replace(/[^a-z0-9]/g, '');
        }
        function normalizeDataString(str) {
            if (!str) return 'Não informado';
            return str.trim().replace(/\s+/g, ' ');
        }
        function toTitleCase(str) {
            if (!str || str === 'Não informado') return str;
            return str.toLowerCase().split(' ').map(word => {
                if (word.length === 0) return '';
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }
        function parseDateTimeRobust(dateTimeStr) {
            if (!dateTimeStr || typeof dateTimeStr !== 'string' || dateTimeStr.trim() === '' || dateTimeStr.includes('#########') || dateTimeStr.includes('#')) { return null; }
            let cleanStr = dateTimeStr.trim().replace(/^"|"$/g, '');
            let date = new Date(cleanStr);
            if (!isNaN(date.getTime())) return date;
            const brRegex = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s+(\d{1,2}):(\d{1,2})(?::(\d{1,2}))?/;
            const match = cleanStr.match(brRegex);
            if (match) {
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10) - 1;
                const year = parseInt(match[3], 10);
                const hour = parseInt(match[4], 10);
                const minute = parseInt(match[5], 10);
                const second = match[6] ? parseInt(match[6], 10) : 0;
                date = new Date(year, month, day, hour, minute, second);
                if (!isNaN(date.getTime())) return date;
            }
            return null;
        }
        function formatDateToYYYYMMDD(date) {
            if (!date || isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
        }
        function formatDateTimeDisplay(date) {
            if (!date || isNaN(date.getTime())) return '';
            return date.toLocaleString('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        }
        function splitCsvLine(line, delimiter) {
            const regex = new RegExp(`${delimiter}(?=(?:(?:[^\"]*\"){2})*[^\"]*$)`);
            let values = line.split(regex);
            values = values.map(val => {
                let trimmed = val.trim();
                if (trimmed.length > 1 && trimmed.startsWith('"') && trimmed.endsWith('"')) {
                    trimmed = trimmed.substring(1, trimmed.length - 1);
                    trimmed = trimmed.replace(/""/g, '"');
                }
                return trimmed;
            });
            return values;
        }
        
        function abbreviateName(fullName, maxLength = 18) {
            if (typeof fullName !== 'string' || fullName.length <= maxLength) {
                return fullName;
            }
            const parts = fullName.trim().split(' ').filter(p => p.length > 0);
            if (parts.length > 1) {
                return `${parts[0]} ${parts[parts.length - 1]}`;
            }
            return fullName.substring(0, maxLength - 3) + '...';
        }

        // --- Processamento de Dados ---
        function detectDelimiter(firstLine) {
            const delimiters = [';', ',', '\t', '|'];
            let bestDelimiter = null;
            let maxCount = 0;
            delimiters.forEach(delim => {
                const count = firstLine.split(delim).length;
                if (count > maxCount) {
                    maxCount = count;
                    bestDelimiter = delim;
                }
            });
            return maxCount > 1 ? bestDelimiter : null;
        }

        function mapHeaders(rawHeaders, aliases) {
            const headerMap = {};
            const normalize = (str) => str ? str.trim().toUpperCase().normalize('NFD').replace(/[̀-ͯ]/g, '') : '';

            const normalizedRawHeaders = rawHeaders.map(normalize);
            console.log('Normalized Raw Headers:', normalizedRawHeaders);

            for (const key in aliases) {
                const aliasList = aliases[key].map(normalize);
                let foundIndex = -1;

                for (const alias of aliasList) {
                    const index = normalizedRawHeaders.indexOf(alias);
                    if (index !== -1) {
                        foundIndex = index;
                        break;
                    }
                }

                if (foundIndex !== -1) {
                    headerMap[key] = rawHeaders[foundIndex];
                }
            }

            console.log('Mapped Headers:', headerMap);
            return headerMap;
        }

        function processData(csvContent) {
            console.log('Iniciando processamento inteligente do CSV...');
            els.main.fileStatus.className = 'text-sm text-slate-400 mt-4';
            els.main.ignoredRowsModal.overlay.classList.add('hidden');

            if (!csvContent || !csvContent.trim()) {
                handleDataLoadError('Arquivo vazio.');
                return;
            }

            if (csvContent.charCodeAt(0) === 0xFEFF) {
                csvContent = csvContent.slice(1);
            }

            const lines = csvContent.trim().split(/\r\n|\n|\r/);
            if (lines.length < 2) {
                handleDataLoadError('Arquivo contém apenas cabeçalho ou está vazio.');
                return;
            }

            const delimiter = detectDelimiter(lines[0]);
            if (!delimiter) {
                handleDataLoadError('Não foi possível detectar o separador de colunas (vírgula, ponto e vírgula ou tabulação).');
                return;
            }
            
            let rawHeaders = splitCsvLine(lines[0], delimiter);
            let emptyCellOffset = 0;
            if (rawHeaders.length > 0 && rawHeaders[0].trim() === '') {
                rawHeaders = rawHeaders.slice(1);
                emptyCellOffset = 1;
            }

            console.log('Raw Headers from CSV (after potential trim):', rawHeaders);
            const headerMap = mapHeaders(rawHeaders, COLUMN_ALIASES);

            const requiredHeaders = ['GRUPO_OPERACIONAL', 'OPERADOR', 'ESTADO', 'DESCRICAO_PAUSA', 'DATA_INICIO', 'TEMPO_PAUSA', 'INICIO_LIVRE', 'SEGUNDOS_EM_LIVRE'];
            const missingHeaders = requiredHeaders.filter(h => !headerMap[h]);

            if (missingHeaders.length > 0) {
                 const missingNames = missingHeaders.map(k => COLUMN_ALIASES[k].join(' ou ')).join('; \n');
                 handleDataLoadError(`Não foi possível encontrar colunas correspondentes a:\n${missingNames}.\nVerifique os cabeçalhos do seu CSV.`);
                 return;
            }

            const headerIndexes = {};
            for(const key in headerMap) {
                const rawHeaderIndex = rawHeaders.indexOf(headerMap[key]);
                if (rawHeaderIndex !== -1) {
                    headerIndexes[key] = rawHeaderIndex + emptyCellOffset;
                }
            }

            let ignoredRowsDetails = [];

            originalData = lines.slice(1).map((line, index) => {
                const currentLineNumber = index + 2;
                const values = splitCsvLine(line, delimiter);

                // A verificação de colunas deve considerar o offset da célula vazia
                if (values.length !== rawHeaders.length + emptyCellOffset) {
                    ignoredRowsDetails.push({ lineNumber: currentLineNumber, reason: 'Número de colunas diferente do cabeçalho', columnName: 'Linha Completa', columnValue: line.substring(0, 150) + (line.length > 150 ? '...' : '') });
                    return null;
                }

                const getColumnValue = (key) => values[headerIndexes[key]] || '';

                const rawDuration = getColumnValue('TEMPO_PAUSA');
                const durationMinutes = parseDurationToMinutes(rawDuration);
                const dateRawValue = getColumnValue('DATA_INICIO');
                const dateObj = parseDateTimeRobust(dateRawValue);
                const operadorRawValue = getColumnValue('OPERADOR');
                const operador = normalizeDataString(operadorRawValue);
                const tipoRawValue = getColumnValue('DESCRICAO_PAUSA');
                const tipo = toTitleCase(normalizeDataString(tipoRawValue));

                let rowProblem = null;
                if (!dateObj) rowProblem = { reason: `Data/Hora de Início inválida ou vazia`, columnName: headerMap.DATA_INICIO, columnValue: dateRawValue };
                else if (durationMinutes <= 0) rowProblem = { reason: `Duração da pausa inválida ou zero`, columnName: headerMap.TEMPO_PAUSA, columnValue: rawDuration };
                else if (operador === 'Não informado' || operadorRawValue.trim() === '') rowProblem = { reason: `Nome do Operador não informado`, columnName: headerMap.OPERADOR, columnValue: operadorRawValue };
                else if (tipo === 'Não informado' || tipoRawValue.trim() === '') rowProblem = { reason: `Descrição da Pausa não informada`, columnName: headerMap.DESCRICAO_PAUSA, columnValue: tipoRawValue };

                if (rowProblem) {
                    ignoredRowsDetails.push({ lineNumber: currentLineNumber, ...rowProblem });
                    return null;
                }

                return {
                    GRUPO_OPERACIONAL: getColumnValue('GRUPO_OPERACIONAL'),
                    CONSULTOR: operador,
                    ESTADO: getColumnValue('ESTADO'),
                    TIPO: tipo,
                    DATA_INICIO_OBJ: dateObj,
                    DATA_FIM: parseDateTimeRobust(getColumnValue('DATA_FIM')),
                    DURACAO_MINUTES: durationMinutes,
                    INICIO_LIVRE: getColumnValue('INICIO_LIVRE'),
                    SEGUNDOS_EM_LIVRE: getColumnValue('SEGUNDOS_EM_LIVRE'),
                    _raw: { duration: rawDuration, date: dateRawValue }
                };
            }).filter(row => row !== null);

            if (originalData.length === 0) {
                if (ignoredRowsDetails.length > 0) showIgnoredRowsPopup(ignoredRowsDetails);
                handleDataLoadError('Nenhuma linha de dados válida encontrada após o processamento.');
                return;
            }

            const dates = originalData.map(d => d.DATA_INICIO_OBJ);
            els.main.filters.startDate.value = formatDateToYYYYMMDD(new Date(Math.min(...dates)));
            els.main.filters.endDate.value = formatDateToYYYYMMDD(new Date(Math.max(...dates)));

            filteredData = [...originalData];
            populateFilters();
            enableDashboardControls(true);

            let statusMsg = `Sucesso! Separador: [${delimiter === '\t' ? 'TAB' : delimiter}]. Carregados ${originalData.length} registros.`;
            if (ignoredRowsDetails.length > 0) {
                statusMsg += ` (${ignoredRowsDetails.length} linhas ignoradas).`;
                showIgnoredRowsPopup(ignoredRowsDetails);
            }

            els.main.fileStatus.textContent = statusMsg;
            els.main.fileStatus.className = 'text-sm text-green-400 mt-4 font-medium';
            updateDashboard();
        }

        function transformArgusData(apiData) {
            if (!Array.isArray(apiData)) {
                console.error("Formato de dados da API inesperado. Esperava um array.");
                handleDataLoadError("A resposta da API não continha os dados esperados.");
                return [];
            }
            return apiData.map(item => {
                const findField = (aliases) => aliases.find(alias => item[alias] !== undefined);

                const consultorField = findField(['operador', 'agent_name', 'consultor', 'nome']);
                const tipoField = findField(['descricao', 'pause_type', 'tipo', 'motivo']);
                const dataInicioField = findField(['inicio', 'start_time', 'data_inicio']);
                const duracaoSecondsField = findField(['duration_seconds']);
                const duracaoStringField = findField(['duracao', 'tempo']);

                const consultor = item[consultorField] || 'Não informado';
                const tipo = item[tipoField] || 'Não informado';
                const dataInicio = item[dataInicioField];
                
                let durationMinutes = 0;
                if (item[duracaoSecondsField] !== undefined) {
                    durationMinutes = (item[duracaoSecondsField] || 0) / 60;
                } else if (item[duracaoStringField] !== undefined) {
                    durationMinutes = parseDurationToMinutes(item[duracaoStringField] || '0');
                }

                return {
                    CONSULTOR: normalizeDataString(consultor),
                    TIPO: toTitleCase(normalizeDataString(tipo)),
                    DATA_INICIO_OBJ: parseDateTimeRobust(dataInicio),
                    DURACAO_MINUTES: durationMinutes
                };
            }).filter(item => item.DATA_INICIO_OBJ && item.DURACAO_MINUTES > 0);
        }
        
        async function loadArgusApiData() {
            els.main.fileInput.value = '';
            els.main.fileUploadLabel.textContent = 'Escolher arquivo';
            els.main.fileStatus.textContent = 'Conectando ao servidor proxy...';
            els.main.fileStatus.className = 'text-sm text-blue-400 mt-4 animate-pulse';

            const PROXY_URL = "http://localhost:3000/api/dados-argus";
            const payload = {};
            
            const selectedTimeOption = document.querySelector('input[name="time-selection"]:checked').value;

            if (selectedTimeOption === 'ultimosMinutos') {
                const ultimosMinutosVal = els.main.apiControls.ultimosMinutos.value.trim();
                if (ultimosMinutosVal && parseInt(ultimosMinutosVal) > 0) {
                    payload.ultimosMinutos = ultimosMinutosVal;
                } else {
                    return handleDataLoadError("Por favor, preencha o campo 'Últimos Minutos'.");
                }
            } else { // selectedTimeOption === 'periodo'
                const startDate = els.main.apiControls.startDate.value;
                const startTime = els.main.apiControls.startTime.value || '00:00';
                const endDate = els.main.apiControls.endDate.value;
                const endTime = els.main.apiControls.endTime.value || '23:59';

                if (!startDate || !endDate) {
                    return handleDataLoadError("Por favor, selecione um período de data/hora.");
                }
                
                payload.periodoInicial = `${startDate}T${startTime}:00`;
                payload.periodoFinal = `${endDate}T${endTime}:00`;
            }

            console.log("Payload enviado para o Proxy:", payload);

            try {
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const responseData = await response.json();

                if (!response.ok) {
                    throw new Error(responseData.descStatus || responseData.error || `Erro do Proxy (${response.status})`);
                }

                if (responseData.codStatus && responseData.codStatus < 1) {
                    throw new Error(responseData.descStatus || "A API Argus retornou um erro.");
                }

                if (!responseData.pausasDetalhadas || !Array.isArray(responseData.pausasDetalhadas)) {
                     throw new Error("Formato de resposta inválido: campo 'pausasDetalhadas' não encontrado.");
                }
                
                originalData = transformArgusData(responseData.pausasDetalhadas);

                if (!originalData || originalData.length === 0) {
                    return handleDataLoadError("A API retornou sucesso, mas nenhum registro de pausa foi encontrado para este filtro.");
                }
                
                const dates = originalData.map(d => d.DATA_INICIO_OBJ);
                els.main.filters.startDate.value = formatDateToYYYYMMDD(new Date(Math.min(...dates)));
                els.main.filters.endDate.value = formatDateToYYYYMMDD(new Date(Math.max(...dates)));

                filteredData = [...originalData];
                populateFilters();
                enableDashboardControls(true);
                els.main.fileStatus.textContent = `Sucesso! ${originalData.length} registros carregados via API Argus.`;
                els.main.fileStatus.className = 'text-sm text-green-400 mt-4 font-medium';
                updateDashboard();

            } catch (error) {
                let msg = error.message;
                if (msg.includes("Failed to fetch")) {
                    msg = "Não foi possível conectar ao servidor proxy. Verifique se ele está rodando no terminal e tente novamente.";
                }
                handleDataLoadError(msg);
            }
        }

        function handleDataLoadError(msg) {
            console.error(msg);
            els.main.fileStatus.textContent = `Erro: ${msg}`;
            els.main.fileStatus.className = 'text-sm text-red-400 mt-4 font-bold';
            originalData = [];
            filteredData = [];
            enableDashboardControls(false);
            updateDashboard();
        }

        function handleCallTabulationsError(msg) {
            console.error(msg);
            els.callTabulations.fileStatus.textContent = `Erro: ${msg}`;
            els.callTabulations.fileStatus.className = 'text-sm text-red-400 mt-4 font-bold';
            callTabulationsOriginalData = [];
            callTabulationsFilteredData = [];
            enableDashboardControls(false, 'callTabulations');
            updateCallTabulationsDashboard();
        }

        // --- Lógica do Dashboard ---
        function populateFilters() {
            const consultants = [...new Set(originalData.map(d => d.CONSULTOR))].sort();
            const pauseTypes = [...new Set(originalData.map(d => d.TIPO))].sort();

            const consultantFilter = els.main.filters.consultant;
            consultantFilter.innerHTML = '<option value="">Todos</option>';
            consultants.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                consultantFilter.appendChild(option);
            });

            const pauseTypeFilter = els.main.filters.pauseType;
            pauseTypeFilter.innerHTML = '<option value="">Todos</option>';
            pauseTypes.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                pauseTypeFilter.appendChild(option);
            });
        }

        function populateCallTabulationFilters() {
            const operators = [...new Set(callTabulationsOriginalData.map(d => d.OPERADOR))].sort();
            const tabulationTypes = [...new Set(callTabulationsOriginalData.map(d => d.TABULADO_COMO))].sort();
            const categories = [...new Set(callTabulationsOriginalData.map(d => d.CATEGORIA_TABULACAO))].sort();

            const operatorFilter = els.callTabulations.filters.operator;
            operatorFilter.innerHTML = '<option value="">Todos</option>';
            operators.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                operatorFilter.appendChild(option);
            });

            const typeFilter = els.callTabulations.filters.type;
            typeFilter.innerHTML = '<option value="">Todos</option>';
            tabulationTypes.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                typeFilter.appendChild(option);
            });

            const categoryFilter = els.callTabulations.filters.category;
            categoryFilter.innerHTML = '<option value="">Todas</option>';
            categories.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                categoryFilter.appendChild(option);
            });
        }
        
        function enableDashboardControls(enable, dashboardType = 'pauses') {
             if (dashboardType === 'pauses') {
                Object.values(els.main.filters).forEach(el => el.disabled = !enable);
                els.main.buttons.clearFilters.disabled = !enable;
                if (!enable) {
                    els.main.buttons.generateAi.disabled = true;
                    els.main.ai.section.classList.add('hidden');
                }
            } else if (dashboardType === 'callTabulations') {
                Object.values(els.callTabulations.filters).forEach(el => el.disabled = !enable);
                els.callTabulations.buttons.clearFilters.disabled = !enable;
            }
        }

        function applyFilters() {
            const selConsultant = els.main.filters.consultant.value;
            const selType = els.main.filters.pauseType.value;

            let startDate = null, endDate = null;
            if (els.main.filters.startDate.value) {
                startDate = new Date(els.main.filters.startDate.value);
                startDate = new Date(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate(), 0,0,0);
            }
            if (els.main.filters.endDate.value) {
                endDate = new Date(els.main.filters.endDate.value);
                endDate = new Date(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate(), 23, 59, 59, 999);
            }

            filteredData = originalData.filter(d => {
                const matchConsultant = !selConsultant || d.CONSULTOR === selConsultant;
                const matchType = !selType || d.TIPO === selType;
                let matchDate = true;
                if (startDate) matchDate = matchDate && d.DATA_INICIO_OBJ >= startDate;
                if (endDate) matchDate = matchDate && d.DATA_INICIO_OBJ <= endDate;
                return matchConsultant && matchType && matchDate;
            });

            const contextData = originalData.filter(d => {
                const matchType = !selType || d.TIPO === selType;
                let matchDate = true;
                if (startDate) matchDate = matchDate && d.DATA_INICIO_OBJ >= startDate;
                if (endDate) matchDate = matchDate && d.DATA_INICIO_OBJ <= endDate;
                return matchType && matchDate;
            });

            filteredAveragesForComparison = {};
            const totals = {};
            const counts = {};
            contextData.forEach(d => {
                totals[d.TIPO] = (totals[d.TIPO] || 0) + d.DURACAO_MINUTES;
                counts[d.TIPO] = (counts[d.TIPO] || 0) + 1;
            });
            for (const type in totals) {
                filteredAveragesForComparison[type] = totals[type] / counts[type];
            }

            const canUseAI = selConsultant && !selType;
            els.main.buttons.generateAi.disabled = !canUseAI;

            if (!canUseAI) els.main.ai.section.classList.add('hidden');

            updateDashboard();
        }

        function applyCallTabulationFilters() {
            const selOperator = els.callTabulations.filters.operator.value;
            const selType = els.callTabulations.filters.type.value;
            const selCategory = els.callTabulations.filters.category.value;

            let startDate = null, endDate = null;
            if (els.callTabulations.filters.startDate.value) {
                startDate = new Date(els.callTabulations.filters.startDate.value);
                startDate = new Date(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate(), 0,0,0);
            }
            if (els.callTabulations.filters.endDate.value) {
                endDate = new Date(els.callTabulations.filters.endDate.value);
                endDate = new Date(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate(), 23, 59, 59, 999);
            }

            callTabulationsFilteredData = callTabulationsOriginalData.filter(d => {
                const matchOperator = !selOperator || d.OPERADOR === selOperator;
                const matchType = !selType || d.TABULADO_COMO === selType;
                const matchCategory = !selCategory || d.CATEGORIA_TABULACAO === selCategory;
                let matchDate = true;
                if (startDate) matchDate = matchDate && d.DATA_HORA_TABULACAO_OBJ >= startDate;
                if (endDate) matchDate = matchDate && d.DATA_HORA_TABULACAO_OBJ <= endDate;
                return matchOperator && matchType && matchCategory && matchDate;
            });

            updateCallTabulationsDashboard();
        }

        function updateDashboard() {
            renderKPIs();
            renderCharts();
            if (tabulatorTable) {
                tabulatorTable.setData(filteredData);
            }
        }

        function processCallTabulationsData(csvContent) {
            console.log('Iniciando processamento do CSV de tabulações...');
            els.callTabulations.fileStatus.className = 'text-sm text-slate-400 mt-4';
            hideIgnoredRowsPopup('pauses'); // Esconde o modal de pausas, se estiver aberto

            if (!csvContent || !csvContent.trim()) {
                return handleCallTabulationsError('Arquivo vazio.');
            }

            if (csvContent.charCodeAt(0) === 0xFEFF) {
                csvContent = csvContent.slice(1);
            }

            const lines = csvContent.trim().split(/\r\n|\n|\r/);
            if (lines.length < 2) {
                return handleCallTabulationsError('Arquivo contém apenas cabeçalho ou está vazio.');
            }

            const delimiter = detectDelimiter(lines[0]);
            if (!delimiter) {
                return handleCallTabulationsError('Não foi possível detectar o separador de colunas.');
            }
            
            let rawHeaders = splitCsvLine(lines[0], delimiter);
            let emptyCellOffset = 0;
            if (rawHeaders.length > 0 && rawHeaders[0].trim() === '') {
                rawHeaders = rawHeaders.slice(1);
                emptyCellOffset = 1;
            }

            console.log('Raw Headers (Tabulações):', rawHeaders);
            const headerMap = mapHeaders(rawHeaders, columnAliasesCallTabulations);

            const requiredHeaders = ['OPERADOR', 'DATA_HORA_TABULACAO', 'TABULADO_COMO', 'CATEGORIA_TABULACAO'];
            const missingHeaders = requiredHeaders.filter(h => !headerMap[h]);

            if (missingHeaders.length > 0) {
                 const missingNames = missingHeaders.map(k => columnAliasesCallTabulations[k].join(' ou ')).join('; \n');
                 return handleCallTabulationsError(`Colunas não encontradas:\n${missingNames}.`);
            }

            const headerIndexes = {};
            for(const key in headerMap) {
                const rawHeaderIndex = rawHeaders.indexOf(headerMap[key]);
                if (rawHeaderIndex !== -1) {
                    headerIndexes[key] = rawHeaderIndex + emptyCellOffset;
                }
            }
            
            const getColumnValue = (key, values) => {
                if (headerIndexes[key] === undefined) return '';
                return values[headerIndexes[key]] || '';
            };

            let ignoredRowsDetails = [];
            callTabulationsOriginalData = lines.slice(1).map((line, index) => {
                const currentLineNumber = index + 2;
                const values = splitCsvLine(line, delimiter);

                if (values.length !== rawHeaders.length + emptyCellOffset) {
                    ignoredRowsDetails.push({ lineNumber: currentLineNumber, reason: 'Número de colunas diferente do cabeçalho', columnName: 'Linha Completa', columnValue: line.substring(0, 150) + (line.length > 150 ? '...' : '') });
                    return null;
                }
                
                const dateRawValue = getColumnValue('DATA_HORA_TABULACAO', values);
                const dateObj = parseDateTimeRobust(dateRawValue);
                const operadorRawValue = getColumnValue('OPERADOR', values);
                const operador = normalizeDataString(operadorRawValue); // Validado aqui

                if (!dateObj) {
                    ignoredRowsDetails.push({ lineNumber: currentLineNumber, reason: 'Data/Hora de Tabulação inválida', columnName: headerMap.DATA_HORA_TABULACAO, columnValue: dateRawValue });
                    return null;
                }
                if (operador === 'Não informado' || operadorRawValue.trim() === '') {
                    ignoredRowsDetails.push({ lineNumber: currentLineNumber, reason: 'Nome do Operador não informado', columnName: headerMap.OPERADOR, columnValue: operadorRawValue });
                    return null;
                }

                // Mapeia todos os campos do alias
                const rowData = {
                    DATA_HORA_TABULACAO_OBJ: dateObj,
                    OPERADOR: operador // <-- *** CORREÇÃO APLICADA AQUI ***
                };
                
                for (const key in columnAliasesCallTabulations) {
                    // Pula os campos que já processamos manualmente
                    if (key !== 'DATA_HORA_TABULACAO' && key !== 'OPERADOR') { 
                        rowData[key] = normalizeDataString(getColumnValue(key, values));
                    }
                }

                return rowData;

            }).filter(row => row !== null);

            if (callTabulationsOriginalData.length === 0) {
                if (ignoredRowsDetails.length > 0) showIgnoredRowsPopup(ignoredRowsDetails, 'pauses');
                return handleCallTabulationsError('Nenhuma linha de dados válida encontrada.');
            }

            const dates = callTabulationsOriginalData.map(d => d.DATA_HORA_TABULACAO_OBJ);
            els.callTabulations.filters.startDate.value = formatDateToYYYYMMDD(new Date(Math.min(...dates)));
            els.callTabulations.filters.endDate.value = formatDateToYYYYMMDD(new Date(Math.max(...dates)));

            callTabulationsFilteredData = [...callTabulationsOriginalData];
            
            populateCallTabulationFilters();
            enableDashboardControls(true, 'callTabulations'); 

            let statusMsg = `Sucesso! Carregados ${callTabulationsOriginalData.length} registros de tabulação.`;
            if (ignoredRowsDetails.length > 0) {
                statusMsg += ` (${ignoredRowsDetails.length} linhas ignoradas).`;
                showIgnoredRowsPopup(ignoredRowsDetails, 'pauses');
            }

            els.callTabulations.fileStatus.textContent = statusMsg;
            els.callTabulations.fileStatus.className = 'text-sm text-green-400 mt-4 font-medium';
            
            updateCallTabulationsDashboard();
        }

        function updateCallTabulationsDashboard() {
            renderCallTabulationCharts();
            console.log("Updating call tabulations dashboard...");
            if (callTabulationsTable) {
                callTabulationsTable.setData(callTabulationsFilteredData);
            } else {
                 callTabulationsTable = new Tabulator(els.callTabulations.tableContainer, {
                    data: callTabulationsFilteredData,
                    height: "500px", // Adiciona scroll
                    layout: "fitData", // Consistente com a outra tabela
                    placeholder: "Carregue um arquivo CSV para ver os dados de tabulação.",
                    columns: [
                        { title: "Operador", field: "OPERADOR", headerFilter: "input", width: 150 },
                        { title: "Tabulado Como", field: "TABULADO_COMO", headerFilter: "input" },
                        { title: "Categoria", field: "CATEGORIA_TABULACAO", headerFilter: "input" },
                        { title: "Data", field: "DATA_HORA_TABULACAO_OBJ", hozAlign: "center", width: 180, formatter: (cell) => formatDateTimeDisplay(cell.getValue()) },
                    ],
                    locale: "pt-br",
                    langs: {
                        "pt-br": {
                            "headerFilters": {
                                "default": "filtrar...",
                            }
                        }
                    }
                });
            }
        }

        // --- Renderização ---
        function renderKPIs() {
            let totalMin = 0;
            const uniqueCons = new Set();
            filteredData.forEach(d => {
                totalMin += d.DURACAO_MINUTES;
                uniqueCons.add(d.CONSULTOR);
            });
            animateValue(els.main.kpis.totalPauses, parseInt(els.main.kpis.totalPauses.innerText) || 0, filteredData.length, 500);
            els.main.kpis.totalDuration.textContent = formatMinutesToHHMM(totalMin);
            animateValue(els.main.kpis.uniqueConsultants, parseInt(els.main.kpis.uniqueConsultants.innerText) || 0, uniqueCons.size, 500);
        }

        function animateValue(obj, start, end, duration) {
            if (start === end) { obj.innerText = end; return; }
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerText = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    obj.innerText = end;
                }
            };
            window.requestAnimationFrame(step);
        }

        function aggregateData(key) {
            const agg = {};
            filteredData.forEach(d => {
                agg[d[key]] = (agg[d[key]] || 0) + d.DURACAO_MINUTES;
            });
            return agg;
        }

        function aggregateTabulationData(key) {
            const agg = {};
            callTabulationsFilteredData.forEach(d => {
                const value = d[key] || 'Não informado';
                agg[value] = (agg[value] || 0) + 1;
            });
            return agg;
        }

        function aggregateAverage(key) {
            const totals = {};
            const counts = {};
            filteredData.forEach(d => {
                totals[d[key]] = (totals[d[key]] || 0) + d.DURACAO_MINUTES;
                counts[d[key]] = (counts[d[key]] || 0) + 1;
            });
            const avgs = {};
            for(const k in totals) avgs[k] = totals[k] / counts[k];
            return avgs;
        }
        
        function createChart(canvasId, chartInstanceVar, type, labels, data, label, color, fullLabels = null, tooltipUnit = 'min') {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[chartInstanceVar]) charts[chartInstanceVar].destroy();

            const chartColors = {
                'doughnut': ['#60A5FA', '#4ADE80', '#FACC15', '#F87171', '#A78BFA', '#F472B6', '#9CA3AF'],
                'barDefault': 'rgba(96, 165, 250, 0.7)',
            };

            const backgroundColor = type === 'doughnut' ? chartColors.doughnut : color || chartColors.barDefault;

            const config = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: type === 'doughnut' ? '#252532' : 'transparent',
                        borderWidth: type === 'doughnut' ? 0.6 : 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: type === 'doughnut',
                            position: 'right',
                            labels: { color: '#cbd5e1' }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    if (fullLabels && tooltipItems.length > 0) {
                                        const dataIndex = tooltipItems[0].dataIndex;
                                        return fullLabels[dataIndex];
                                    }
                                    return tooltipItems[0].label;
                                },
                                label: function(context) {
                                    let val = context.raw;
                                    let lbl = (type === 'doughnut') ? context.label : '';
                                    if (lbl) lbl += ': ';
                                    if (type === 'doughnut') {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const perc = total > 0 ? ((val / total) * 100).toFixed(1) + '%' : '0%';
                                        if (tooltipUnit === 'min') {
                                            return `${lbl}${formatMinutesToHHMM(val)} (${perc})`;
                                        } else {
                                            return `${lbl}${val} (${perc})`;
                                        }
                                    }
                                    if (tooltipUnit === 'min') {
                                        return `Duração: ${formatMinutesToHHMM(val)} (${val.toFixed(1)} min)`;
                                    } else {
                                        return `${label}: ${val}`;
                                    }
                                }
                            }
                        }
                    },
                    scales: (type === 'bar') ? {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { color: 'transparent' },
                            ticks: { 
                                color: '#94a3b8',
                                maxRotation: 45,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        }
                    } : {}
                }
            };

            charts[chartInstanceVar] = new Chart(ctx, config);
        }

        function renderCharts() {
            const consData = aggregateData('CONSULTOR');
            const consLabels = Object.keys(consData).sort((a, b) => consData[b] - consData[a]);
            const abbreviatedLabels = consLabels.map(name => abbreviateName(name));
            createChart(
                'total-pause-consultant-chart', 
                'consultantTotal', 
                'bar', 
                abbreviatedLabels,
                consLabels.map(k => consData[k]), 
                'Total Duração', 
                'rgba(167, 139, 250, 0.7)',
                consLabels,
                'min'
            );

            const typeData = aggregateData('TIPO');
            const typeLabels = Object.keys(typeData).sort();
            createChart('total-pause-type-chart', 'typeTotal', 'bar', typeLabels, typeLabels.map(k => typeData[k]), 'Total Duração', 'rgba(74, 222, 128, 0.7)', null, 'min');

            const typeAvgData = aggregateAverage('TIPO');
            const avgChartData = typeLabels.map(type => typeAvgData[type] || 0);
            createChart('average-pause-type-chart', 'typeAverage', 'bar', typeLabels, avgChartData, 'Média Duração', 'rgba(250, 204, 21, 0.7)', null, 'min');

            createChart('pause-type-distribution-chart', 'typeDistribution', 'doughnut', typeLabels, typeLabels.map(k => typeData[k]), 'Distribuição', null, null, 'min');
        }

        function renderCallTabulationCharts() {
            const operatorData = aggregateTabulationData('OPERADOR');
            const operatorLabels = Object.keys(operatorData).sort((a, b) => operatorData[b] - operatorData[a]);
            const abbreviatedOperatorLabels = operatorLabels.map(name => abbreviateName(name));
            createChart(
                'total-tabulations-operator-chart',
                'tabulationOperatorTotal',
                'bar',
                abbreviatedOperatorLabels,
                operatorLabels.map(k => operatorData[k]),
                'Total de Tabulações',
                'rgba(167, 139, 250, 0.7)',
                operatorLabels,
                'count'
            );

            const typeData = aggregateTabulationData('TABULADO_COMO');
            const typeLabels = Object.keys(typeData).sort();
            createChart(
                'total-tabulations-type-chart',
                'tabulationTypeTotal',
                'bar',
                typeLabels,
                typeLabels.map(k => typeData[k]),
                'Total de Tabulações',
                'rgba(74, 222, 128, 0.7)',
                null,
                'count'
            );

            const categoryData = aggregateTabulationData('CATEGORIA_TABULACAO');
            const categoryLabels = Object.keys(categoryData).sort();
            createChart(
                'total-tabulations-category-chart',
                'tabulationCategoryTotal',
                'bar',
                categoryLabels,
                categoryLabels.map(k => categoryData[k]),
                'Total de Tabulações',
                'rgba(250, 204, 21, 0.7)',
                null,
                'count'
            );

            createChart(
                'tabulation-type-distribution-chart',
                'tabulationTypeDistribution',
                'doughnut',
                typeLabels,
                typeLabels.map(k => typeData[k]),
                'Distribuição de Tabulações',
                null,
                null,
                'count'
            );
        }

        // --- Integração IA (Gemini) ---
        async function generateAIAnalysis() {
            const uniqueConsultants = [...new Set(filteredData.map(d => d.CONSULTOR))];
            if (uniqueConsultants.length !== 1) {
                console.log("AI Analysis skipped: not exactly one consultant selected.");
                return;
            }
            const consultant = uniqueConsultants[0];

            els.main.ai.section.classList.remove('hidden');
            els.main.ai.placeholder.classList.add('hidden');
            els.main.ai.loading.classList.remove('hidden');
            els.main.ai.content.innerHTML = '';
            els.main.ai.section.scrollIntoView({ behavior: 'smooth' });

            const totalPausas = filteredData.length;
            const totalMinutos = filteredData.reduce((sum, d) => sum + d.DURACAO_MINUTES, 0);

            const typeStats = {};
            filteredData.forEach(d => {
                if(!typeStats[d.TIPO]) typeStats[d.TIPO] = { total: 0, count: 0 };
                typeStats[d.TIPO].total += d.DURACAO_MINUTES;
                typeStats[d.TIPO].count++;
            });

            let dataText = `Consultor: ${consultant}\nPeríodo: ${els.main.filters.startDate.value} a ${els.main.filters.endDate.value}\nTotal Pausas: ${totalPausas}, Tempo Total: ${formatMinutesToHHMM(totalMinutos)}\n\nDetalhamento por Tipo:\n`;

            for(const type in typeStats) {
                const stats = typeStats[type];
                const avg = stats.total / stats.count;
                const contextAvg = filteredAveragesForComparison[type] || 0;
                let statusDescription = '';
                const expected = expectedDurations[type];
                if (expected) {
                    const lowerBound = expected.minutes - expected.tolerance;
                    const upperBound = expected.minutes + expected.tolerance;
                    if (avg >= lowerBound && avg <= upperBound) statusDescription = `(duração ideal: ${expected.minutes}min - Média OK)`;
                    else if (avg < lowerBound) statusDescription = `(duração ideal: ${expected.minutes}min - Média Curta)`;
                    else statusDescription = `(duração ideal: ${expected.minutes}min - Média Longa)`;
                } else {
                    const diffPerc = contextAvg > 0 ? ((avg - contextAvg) / contextAvg) * 100 : 0;
                    if (diffPerc > 10) statusDescription = `(Média da Equipe: ${contextAvg.toFixed(1)}min, ACIMA da média da equipe +${diffPerc.toFixed(0)}%)`;
                    else if (diffPerc < -10) statusDescription = `(Média da Equipe: ${contextAvg.toFixed(1)}min, ABAIXO da média da equipe ${diffPerc.toFixed(0)}%)`;
                    else statusDescription = `(Média da Equipe: ${contextAvg.toFixed(1)}min, na média da equipe)`;
                }
                dataText += `- ${type}: ${stats.count}x, Total: ${formatMinutesToHHMM(stats.total)}, Média: ${avg.toFixed(1)}min ${statusDescription}.\n`;
            }

            const prompt = `
                Aja como um analista de performance sênior de call center. Analise os dados de pausas abaixo para o consultor.
                As seguintes regras de negócio *fixas* devem ser consideradas como padrão da operação:
                - Pausa para Almoço: 60 minutos (1 hora).
                - Pausa para Café ou Intervalo: 15 minutos.
                - Pausa para Banheiro: 10 minutos.
                - Pausa para Negociação: 15 minutos.
                - Cadastrando Proposta: 10 minutos.
                Para outros tipos de pausas não listados acima, compare a média do consultor com a média geral da equipe no período filtrado para identificar desvios.
                Dados:\n${dataText}\n
                Instruções:
                1. Crie um resumo executivo curto (máx 3 linhas) sobre o comportamento de pausas do consultor, mantendo tom profissional.
                2. Destaque 1 ponto positivo e 1 ponto de atenção principal.
                3. Dê 2 sugestões práticas e diretas para o gestor aplicar com este consultor.
                Use formatação Markdown (negrito para destaques). Seja conciso.
            `;

            try {
                if (!window.geminiApiKey) {
                    const response = await fetch('/api/gemini-key');
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Falha ao obter a chave da API Gemini do servidor.');
                    }
                    const data = await response.json();
                    window.geminiApiKey = data.apiKey;
                }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${window.geminiApiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `Erro API IA: ${response.status}`);
                }
                const data = await response.json();
                const aiText = data.candidates[0]?.content?.parts[0]?.text;
                if (!aiText) throw new Error('Resposta da IA vazia ou malformada.');
                const htmlText = aiText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                els.main.ai.content.innerHTML = `<div class="prose prose-invert max-w-none">${htmlText}</div>`;
            } catch (error) {
                console.error(error);
                els.main.ai.content.innerHTML = `<p class="text-red-400 font-medium">Falha ao gerar análise. (${error.message})</p>`;
            } finally {
                els.main.ai.loading.classList.add('hidden');
            }
        }

        // --- Funções do Modal de Erros ---
        function showIgnoredRowsPopup(errors, dashboardType = 'pauses') {
            let modal, overlay, countEl, listEl;

            if (dashboardType === 'pauses') {
                modal = els.main.ignoredRowsModal.modal;
                overlay = els.main.ignoredRowsModal.overlay;
                countEl = els.main.ignoredRowsModal.count;
                listEl = els.main.ignoredRowsModal.list;
            } 
            // Adicionar lógica para 'callTabulations' quando o modal for implementado no HTML

            if (modal && overlay && countEl && listEl) {
                countEl.textContent = errors.length;
                listEl.innerHTML = '';
                errors.slice(0, 100).forEach(err => { // Limita a 100 para não travar o navegador
                    const li = document.createElement('li');
                    li.className = 'error-item';
                    li.innerHTML = `<p><strong>Linha ${err.lineNumber}:</strong> ${err.reason}</p><p>Campo: <span>${err.columnName || 'N/A'}</span>, Valor: <span>"${err.columnValue || 'Vazio'}"</span></p>`;
                    listEl.appendChild(li);
                });
                overlay.classList.remove('hidden');
            }
        }

        function hideIgnoredRowsPopup(dashboardType = 'pauses') {
            let overlay;
            if (dashboardType === 'pauses') {
                overlay = els.main.ignoredRowsModal.overlay;
            }
            // Adicionar lógica para 'callTabulations'

            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        // --- Função para controlar a Sidebar ---
        function setupSidebar() {
            const openBtn = document.getElementById('sidebar-open-btn');
            const closeBtn = document.getElementById('sidebar-close-btn');
            const overlay = document.getElementById('sidebar-overlay');
            const body = document.body;

            const toggleSidebar = () => {
                body.classList.toggle('sidebar-open');
            };

            if (openBtn) {
                openBtn.addEventListener('click', toggleSidebar);
            }
            if (closeBtn) {
                closeBtn.addEventListener('click', toggleSidebar);
            }
            if (overlay) {
                overlay.addEventListener('click', toggleSidebar);
            }
        }

        // --- Inicialização e Event Listeners ---
        function init() {
            setupSidebar();

            tabulatorTable = new Tabulator("#pause-detail-table", {
                height: "500px",
                layout: "fitData",
                placeholder: "<span class='text-slate-400'>Nenhum dado para exibir. Carregue um arquivo CSV ou use a API.</span>",
                columns: [
                    { title: "Consultor", field: "CONSULTOR", headerFilter: "input", width: 150 },
                    { title: "Tipo de Pausa", field: "TIPO", headerFilter: "input" },
                    { title: "Data Início", field: "DATA_INICIO_OBJ", hozAlign: "center", width: 180, formatter: (cell) => formatDateTimeDisplay(cell.getValue()) },
                    { title: "Duração (HH:MM:SS)", field: "DURACAO_MINUTES", hozAlign: "center", formatter: (cell) => formatMinutesToHHMMSS(cell.getValue()) },
                    { title: "Duração (Min)", field: "DURACAO_MINUTES", hozAlign: "right", formatter: (c) => c.getValue().toFixed(1) },
                    { title: "Meta / Média (Min)", field: "TIPO", hozAlign: "right", formatter: (cell) => {
                        const type = cell.getValue();
                        const expected = expectedDurations[type];
                        if (expected) return expected.minutes.toFixed(1);
                        const avg = filteredAveragesForComparison[type] || 0;
                        return avg.toFixed(1);
                    }},
                    { title: "Status", field: "DURACAO_MINUTES", hozAlign: "center", formatter: (cell) => {
                        const duration = cell.getValue();
                        const type = cell.getRow().getData().TIPO;
                        const expected = expectedDurations[type];
                        let statusText = '';

                        if (expected) {
                            const lowerBound = expected.minutes - expected.tolerance;
                            const upperBound = expected.minutes + expected.tolerance;
                            if (duration >= lowerBound && duration <= upperBound) {
                                statusText = '<span class="status-success font-medium">✓ Correto</span>';
                            } else if (duration < lowerBound) {
                                statusText = '<span class="status-warning font-semibold">↓ Curto</span>';
                            } else {
                                statusText = '<span class="status-danger font-semibold">↑ Longo</span>';
                            }
                        } else {
                            const avg = filteredAveragesForComparison[type] || 0;
                            const isAbove = duration > (avg * 1.1) && avg > 0;
                            statusText = isAbove
                                ? '<span class="status-danger font-semibold">↑ Acima</span>'
                                : '<span class="status-success font-medium">✓ Normal</span>';
                        }
                        return statusText;
                    }}
                ],
                locale: "pt-br",
                langs:{
                    "pt-br":{
                        "headerFilters":{
                            "default":"filtrar...",
                        }
                    }
                }
            });

            els.main.fileInput.addEventListener('change', (e) => {
                hideIgnoredRowsPopup('pauses');
                const file = e.target.files[0];
                
                if (!file) {
                    els.main.fileUploadLabel.textContent = 'Escolher arquivo';
                    return;
                }

                els.main.fileUploadLabel.textContent = file.name;
                els.main.fileStatus.textContent = `Lendo "${file.name}"...`;
                els.main.fileStatus.className = 'text-sm text-blue-400 mt-4 animate-pulse';

                const reader = new FileReader();
                reader.onload = (evt) => processData(evt.target.result);
                reader.onerror = () => handleDataLoadError('Falha ao ler o arquivo.');
                reader.readAsText(file, 'UTF-8');
            });

            els.callTabulations.fileInput.addEventListener('change', (e) => {
                //hideIgnoredRowsPopup('callTabulations');
                const file = e.target.files[0];
                if (!file) {
                    els.callTabulations.fileStatus.textContent = 'Nenhum arquivo selecionado.';
                    els.callTabulations.fileStatus.className = 'text-sm text-gray-500 mt-4';
                    return;
                }

                els.callTabulations.fileStatus.textContent = `Lendo "${file.name}"...`;
                els.callTabulations.fileStatus.className = 'text-sm text-blue-400 mt-4 animate-pulse';

                const reader = new FileReader();
                reader.onload = (evt) => processCallTabulationsData(evt.target.result);
                reader.onerror = () => handleDataLoadError('Falha ao ler o arquivo de tabulações.'); // Reutiliza o handler principal
                reader.readAsText(file, 'UTF-8');
            });

            els.main.buttons.loadArgusApi.addEventListener('click', loadArgusApiData);
            els.main.buttons.clearFilters.addEventListener('click', () => {
                if (originalData.length > 0) {
                    const dates = originalData.map(d => d.DATA_INICIO_OBJ);
                    els.main.filters.startDate.value = formatDateToYYYYMMDD(new Date(Math.min(...dates)));
                    els.main.filters.endDate.value = formatDateToYYYYMMDD(new Date(Math.max(...dates)));
                }
                els.main.filters.consultant.value = '';
                els.main.filters.pauseType.value = '';
                applyFilters();
            });
            els.main.buttons.generateAi.addEventListener('click', generateAIAnalysis);
            document.getElementById('floating-ai-btn').addEventListener('click', generateAIAnalysis);
            els.main.buttons.closeAi.addEventListener('click', () => {
                els.main.ai.section.classList.add('hidden');
                els.main.ai.placeholder.classList.remove('hidden');
                els.main.ai.content.innerHTML = '';
            });

            const debouncedApplyFilters = debounce(applyFilters, 300);
            Object.values(els.main.filters).forEach(filter => {
                filter.addEventListener('change', debouncedApplyFilters);
            });

            const debouncedApplyCallTabulationFilters = debounce(applyCallTabulationFilters, 300);
            Object.values(els.callTabulations.filters).forEach(filter => {
                filter.addEventListener('change', debouncedApplyCallTabulationFilters);
            });

            els.callTabulations.buttons.clearFilters.addEventListener('click', () => {
                if (callTabulationsOriginalData.length > 0) {
                    const dates = callTabulationsOriginalData.map(d => d.DATA_HORA_TABULACAO_OBJ);
                    els.callTabulations.filters.startDate.value = formatDateToYYYYMMDD(new Date(Math.min(...dates)));
                    els.callTabulations.filters.endDate.value = formatDateToYYYYMMDD(new Date(Math.max(...dates)));
                }
                els.callTabulations.filters.operator.value = '';
                els.callTabulations.filters.type.value = '';
                els.callTabulations.filters.category.value = '';
                applyCallTabulationFilters();
            });

            els.main.ignoredRowsModal.closeBtn.addEventListener('click', () => hideIgnoredRowsPopup('pauses'));
            els.main.ignoredRowsModal.overlay.addEventListener('click', (e) => {
                if (e.target === els.main.ignoredRowsModal.overlay) hideIgnoredRowsPopup('pauses');
            });
            
            enableDashboardControls(false, 'pauses');
            enableDashboardControls(false, 'callTabulations');
            
            const timeSelectionRadios = document.querySelectorAll('input[name="time-selection"]');
            const periodoInputsDiv = document.getElementById('periodo-inputs');
            const ultimosMinutosInputsDiv = document.getElementById('ultimos-minutos-inputs');

            timeSelectionRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (event.target.value === 'periodo') {
                        periodoInputsDiv.classList.remove('hidden');
                        ultimosMinutosInputsDiv.classList.add('hidden');
                    } else {
                        periodoInputsDiv.classList.add('hidden');
                        ultimosMinutosInputsDiv.classList.remove('hidden');
                    }
                });
            });

            const today = new Date();
            els.main.apiControls.startDate.value = formatDateToYYYYMMDD(today);
            els.main.apiControls.endDate.value = formatDateToYYYYMMDD(today);
            els.main.apiControls.startTime.value = '00:00';
            els.main.apiControls.endTime.value = '23:59';

            function showDashboard(dashboardType) {
                const isPauses = dashboardType === 'pauses';
                
                // Conteúdo principal
                els.main.pausesDashboardContent.classList.toggle('hidden', !isPauses);
                els.callTabulations.dashboardContent.classList.toggle('hidden', isPauses);
                
                // Botões da Aba
                els.main.tabPausasBtn.classList.toggle('active', isPauses);
                els.main.tabCallTabulationsBtn.classList.toggle('active', !isPauses);

                // Conteúdo da Sidebar
                document.getElementById('pauses-sidebar-content').classList.toggle('hidden', !isPauses);
                document.getElementById('tabulations-sidebar-content').classList.toggle('hidden', isPauses);

                if (isPauses) {
                    if(originalData.length > 0) updateDashboard();
                } else {
                    updateCallTabulationsDashboard();
                }
            }

            els.main.tabPausasBtn.addEventListener('click', () => showDashboard('pauses'));
            els.main.tabCallTabulationsBtn.addEventListener('click', () => showDashboard('call-tabulations'));

            showDashboard('pauses');
        }

        function exportarDadosParaHtml() {
            const tabela = document.getElementById('pause-detail-table');
            const nomeArquivo = 'dados_pausa.html';
            const html = tabela.outerHTML;
            const link = document.createElement('a');
            link.href = 'data:text/html;charset=utf-8,' + encodeURIComponent(html);
            link.download = nomeArquivo;
            link.click();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
    <button id="floating-ai-btn" class="fixed bottom-6 right-6 z-50 p-4 rounded-full bg-blue-600 text-white shadow-lg hover:bg-blue-700 transition-all duration-300 ease-in-out transform hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
    </button>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
        </svg>
    </button>
</body>
</html>